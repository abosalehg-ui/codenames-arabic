<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F1419">
    <title>Code Names - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ============================================ */
/* ğŸ¨ CSS VARIABLES - Mobile-First */
/* ============================================ */
:root {
    /* Colors */
    --color-red: #FF3B5C;
    --color-red-dark: #E5315A;
    --color-blue: #2D5FF5;
    --color-blue-dark: #1E4FE0;
    
    --color-bg: #0F1419;
    --color-bg-light: #1A1F2E;
    --color-card: #252B3A;
    --color-card-hover: #2E3548;
    
    --color-accent: #FFB800;
    --color-success: #00D9A3;
    --color-danger: #FF3B5C;
    --color-assassin: #13151C;
    --color-innocent: #3D4556;
    
    --color-text: #FFFFFF;
    --color-text-secondary: #A0A8B8;
    --color-text-muted: #6B7280;
    
    /* Spacing - Mobile-First */
    --space-xs: 8px;
    --space-sm: 12px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    
    /* Touch Areas */
    --touch-min: 48px;
    --touch-comfortable: 56px;
    
    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --radius-full: 9999px;
    
    /* Shadows */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
    
    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 400ms ease;
    
    /* Safe Areas (for notch devices) */
    --safe-top: env(safe-area-inset-top, 0);
    --safe-bottom: env(safe-area-inset-bottom, 0);
    --safe-left: env(safe-area-inset-left, 0);
    --safe-right: env(safe-area-inset-right, 0);
}

/* ============================================ */
/* ğŸŒ GLOBAL RESET & BASE STYLES */
/* ============================================ */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
}

html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    font-family: 'Cairo', sans-serif;
    background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-light) 100%);
    background-attachment: fixed;
    color: var(--color-text);
    overflow-x: hidden;
    line-height: 1.6;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    position: relative;
}

/* Remove iOS input zoom */
input, textarea, select {
    font-size: 16px;
}

/* ============================================ */
/* ğŸ“± SCREEN MANAGEMENT */
/* ============================================ */
.screen {
    min-height: 100vh;
    min-height: -webkit-fill-available;
    display: none;
    flex-direction: column;
    padding: var(--space-md);
    padding-top: calc(var(--safe-top) + var(--space-md));
    padding-bottom: calc(var(--safe-bottom) + var(--space-md));
    opacity: 0;
    transform: translateY(20px);
    transition: opacity var(--transition-normal), transform var(--transition-normal);
}

.screen.active {
    display: flex;
    opacity: 1;
    transform: translateY(0);
}

/* ============================================ */
/* ğŸ¯ SPLASH SCREEN */
/* ============================================ */
#splash-screen {
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at center, var(--color-bg-light) 0%, var(--color-bg) 100%);
}

.splash-logo {
    font-size: clamp(3rem, 15vw, 5rem);
    animation: pulse 2s infinite;
}

.splash-title {
    font-size: clamp(2rem, 8vw, 3rem);
    font-weight: 900;
    margin-top: var(--space-lg);
    background: linear-gradient(135deg, var(--color-blue), var(--color-accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
}

.splash-subtitle {
    font-size: 1.2rem;
    color: var(--color-text-secondary);
    margin-top: var(--space-sm);
    text-align: center;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* ============================================ */
/* ğŸ“– ONBOARDING SCREENS */
/* ============================================ */
#onboarding-screen {
    padding: 0;
    position: relative;
}

.onboarding-container {
    display: flex;
    overflow-x: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    height: 100vh;
    height: -webkit-fill-available;
}

.onboarding-slide {
    min-width: 100%;
    scroll-snap-align: start;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: var(--space-xl);
    text-align: center;
}

.onboarding-icon {
    font-size: 6rem;
    margin-bottom: var(--space-lg);
}

.onboarding-slide h2 {
    font-size: clamp(1.8rem, 6vw, 2.5rem);
    font-weight: 800;
    margin-bottom: var(--space-md);
}

.onboarding-slide p {
    font-size: 1.1rem;
    color: var(--color-text-secondary);
    line-height: 1.8;
    max-width: 400px;
}

.onboarding-dots {
    position: absolute;
    bottom: calc(var(--safe-bottom) + 120px);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: var(--space-sm);
}

.onboarding-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--color-text-muted);
    transition: all var(--transition-fast);
}

.onboarding-dot.active {
    width: 24px;
    background: var(--color-blue);
}

.onboarding-footer {
    position: absolute;
    bottom: calc(var(--safe-bottom) + var(--space-lg));
    left: var(--space-md);
    right: var(--space-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-skip {
    color: var(--color-text-secondary);
    font-size: 1rem;
    font-weight: 600;
    background: none;
    border: none;
    padding: var(--space-sm);
    cursor: pointer;
}

/* ============================================ */
/* ğŸ¨ BUTTONS - Mobile-First */
/* ============================================ */
.btn {
    min-height: var(--touch-comfortable);
    padding: 0 var(--space-lg);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1.1rem;
    font-weight: 700;
    font-family: 'Cairo', sans-serif;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
}

.btn:active {
    transform: scale(0.97);
}

.btn-primary {
    background: linear-gradient(135deg, var(--color-blue), var(--color-blue-dark));
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-accent {
    background: linear-gradient(135deg, var(--color-accent), #FFA500);
    color: var(--color-bg);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: linear-gradient(135deg, var(--color-success), #00B887);
    color: white;
}

.btn-danger {
    background: linear-gradient(135deg, var(--color-danger), var(--color-red-dark));
    color: white;
}

.btn-ghost {
    background: transparent;
    color: var(--color-text-secondary);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.btn-large {
    min-height: var(--touch-comfortable);
    font-size: 1.2rem;
    padding: 0 var(--space-xl);
}

.btn-full {
    width: 100%;
}

.btn-icon {
    font-size: 1.4rem;
}

/* ============================================ */
/* ğŸ” AUTH SCREEN */
/* ============================================ */
.auth-header {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.auth-header h1 {
    font-size: clamp(2rem, 8vw, 3rem);
    font-weight: 900;
    margin-bottom: var(--space-sm);
}

.auth-subtitle {
    font-size: 1.1rem;
    color: var(--color-text-secondary);
}

.card {
    background: var(--color-card);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-md);
    box-shadow: var(--shadow-md);
}

.input-group {
    margin-bottom: var(--space-md);
}

.input-group label {
    display: block;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xs);
}

.input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.input-icon {
    position: absolute;
    right: var(--space-md);
    font-size: 1.3rem;
    color: var(--color-text-muted);
    pointer-events: none;
}

input {
    width: 100%;
    min-height: var(--touch-comfortable);
    padding: 0 var(--space-xl) 0 var(--space-md);
    background: var(--color-bg-light);
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 1rem;
    font-family: 'Cairo', sans-serif;
    transition: all var(--transition-fast);
}

input:focus {
    outline: none;
    border-color: var(--color-blue);
    background: var(--color-card-hover);
}

.button-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

/* ============================================ */
/* ğŸ  LOBBY SCREEN */
/* ============================================ */
.lobby-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.action-card {
    background: var(--color-card);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-md);
}

.action-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.action-icon {
    font-size: 2.5rem;
}

.action-header h3 {
    font-size: 1.4rem;
    font-weight: 700;
}

.action-description {
    font-size: 0.95rem;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-md);
    line-height: 1.6;
}

/* ============================================ */
/* â³ WAITING ROOM */
/* ============================================ */
.waiting-header {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.room-code-display {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    background: var(--color-card);
    border-radius: var(--radius-lg);
    margin-top: var(--space-md);
}

.room-code-label {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
}

.room-code-value {
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--color-accent);
    letter-spacing: 3px;
}

.team-selection {
    margin-bottom: var(--space-xl);
}

.team-selection h3 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
}

.role-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.role-btn {
    min-height: 120px;
    padding: var(--space-md);
    border: 3px solid transparent;
    border-radius: var(--radius-lg);
    background: var(--color-card);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    touch-action: manipulation;
}

.role-btn:active {
    transform: scale(0.97);
}

.role-icon-large {
    font-size: 2.5rem;
}

.role-name {
    font-size: 1rem;
    font-weight: 700;
    text-align: center;
}

.role-btn-red {
    border-color: var(--color-red);
}

.role-btn-red.selected {
    background: linear-gradient(135deg, var(--color-red), var(--color-red-dark));
    box-shadow: 0 0 20px rgba(255, 59, 92, 0.6);
}

.role-btn-blue {
    border-color: var(--color-blue);
}

.role-btn-blue.selected {
    background: linear-gradient(135deg, var(--color-blue), var(--color-blue-dark));
    box-shadow: 0 0 20px rgba(45, 95, 245, 0.6);
}

.players-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.players-list li {
    padding: var(--space-md);
    background: var(--color-card);
    border-radius: var(--radius-md);
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

/* ---------------------------------- */
/* NEW ROLE BADGE STYLES (for Issue 2) */
/* ---------------------------------- */
.player-badge {
    position: sticky;
    top: 0;
    left: var(--space-md);
    right: var(--space-md);
    z-index: 101;
    background: var(--color-card);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    box-shadow: var(--shadow-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
}

.badge-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.badge-team {
    font-size: 1.1rem;
}

.badge-role {
    font-weight: 600;
    color: var(--color-accent);
}

.badge-score-small {
    font-size: 1.1rem;
    font-weight: 900;
}

/* ============================================ */
/* ğŸ® GAME SCREEN - Mobile Portrait */
/* ============================================ */
#game-screen {
    padding: 0;
    display: grid;
    /* Changed grid-template-rows to accommodate the new badge */
    grid-template-rows: auto auto 1fr auto;
    gap: 0;
    padding-top: calc(var(--safe-top) + var(--space-md));
}

.game-header {
    background: var(--color-card);
    padding: var(--space-md);
    /* Removed padding-top here as it's now on #game-screen */
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 100;
}

.game-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
}

.team-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.score-label {
    font-size: 0.85rem;
    font-weight: 600;
}

.score-value {
    font-size: 2rem;
    font-weight: 900;
}

.team-red .score-value {
    color: var(--color-red);
}

.team-blue .score-value {
    color: var(--color-blue);
}

.turn-indicator {
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
}

.clue-display {
    background: var(--color-bg-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    text-align: center;
    margin-top: var(--space-sm);
}

.clue-label {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    margin-bottom: 4px;
}

.clue-word {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-accent);
}

.clue-count {
    font-size: 1.2rem;
    color: var(--color-text-secondary);
    margin-top: 4px;
}

.game-board-container {
    padding: var(--space-md);
    /* FIX: Increased padding to prevent overlap (Issue 3) */
    padding-bottom: 120px; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.game-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-sm);
    max-width: 600px;
    margin: 0 auto;
}

.card-word {
    aspect-ratio: 1;
    background: var(--color-card);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 0.9rem;
    font-weight: 700;
    padding: var(--space-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
    touch-action: manipulation;
}

.card-word:active:not(.revealed) {
    transform: scale(0.95);
}

.card-word.revealed {
    cursor: not-allowed;
}

.card-word.RED {
    background: linear-gradient(135deg, var(--color-red), var(--color-red-dark));
    color: white;
    border-color: var(--color-red);
}

.card-word.BLUE {
    background: linear-gradient(135deg, var(--color-blue), var(--color-blue-dark));
    color: white;
    border-color: var(--color-blue);
}

.card-word.INNOCENT {
    background: var(--color-innocent);
    color: var(--color-text-secondary);
}

.card-word.ASSASSIN {
    background: linear-gradient(135deg, var(--color-assassin), #000000);
    color: white;
    border-color: var(--color-danger);
    animation: assassinPulse 1s infinite;
}

@keyframes assassinPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(255, 59, 92, 0.8); }
    50% { box-shadow: 0 4px 30px rgba(255, 59, 92, 1); }
}

.game-controls {
    /* Increased z-index to ensure it is always on top (Issue 3) */
    z-index: 500;
    background: var(--color-card);
    padding: var(--space-md);
    padding-bottom: calc(var(--safe-bottom) + var(--space-md));
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.4);
    position: sticky;
    bottom: 0;
}

.control-input-group {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
}

.control-input {
    flex: 1;
}

/* ============================================ */
/* ğŸ”„ LANDSCAPE MODE */
/* ============================================ */
@media (orientation: landscape) and (max-height: 600px) {
    #game-screen {
        grid-template-columns: 1fr 2fr;
        grid-template-rows: 1fr;
    }
    
    .player-badge {
        /* Adjust for landscape layout */
        position: static;
        margin-top: var(--space-md);
    }
    
    .game-header {
        position: static;
    }
    
    .game-board-container {
        grid-column: 2;
        grid-row: 1;
    }
    
    .game-controls {
        position: static;
        grid-column: 1;
        grid-row: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .game-grid {
        gap: var(--space-xs);
    }
    
    .card-word {
        font-size: 0.75rem;
    }
}

/* ============================================ */
/* ğŸ“± TABLET & LARGER SCREENS */
/* ============================================ */
@media (min-width: 768px) {
    .screen {
        padding: var(--space-xl);
    }
    
    .card {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .role-grid {
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .game-grid {
        gap: var(--space-md);
        max-width: 700px;
    }
    
    .card-word {
        font-size: 1.1rem;
    }
}

/* ============================================ */
/* ğŸ–¥ï¸ DESKTOP */
/* ============================================ */
@media (min-width: 1024px) {
    #game-screen {
        grid-template-columns: 350px 1fr;
        grid-template-rows: 1fr;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .game-header {
        grid-column: 1;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
    }
    
    .game-board-container {
        grid-column: 2;
    }
    
    .game-controls {
        grid-column: 1;
        position: static;
    }
    
    .player-badge {
        /* Adjust for desktop layout */
        position: static;
        margin-top: 0;
    }
}

/* ============================================ */
/* ğŸ­ MODAL */
/* ============================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-normal);
    padding: var(--space-md);
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal-content {
    background: var(--color-card);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    max-width: 400px;
    width: 100%;
    box-shadow: var(--shadow-lg);
    text-align: center;
    transform: scale(0.9);
    transition: transform var(--transition-normal);
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

.modal-icon {
    font-size: 4rem;
    margin-bottom: var(--space-md);
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
}

.modal-message {
    font-size: 1rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-lg);
}

.modal-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

/* ============================================ */
/* ğŸ¯ UTILITY CLASSES */
/* ============================================ */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-auto {
    margin-top: auto;
}

.mb-md {
    margin-bottom: var(--space-md);
}

.mb-lg {
    margin-bottom: var(--space-lg);
}

.mb-xl {
    margin-bottom: var(--space-xl);
}
    </style>
</head>
<body>

<div id="splash-screen" class="screen active">
    <div class="splash-logo">ğŸ¯</div>
    <h1 class="splash-title">Code Names</h1>
    <p class="splash-subtitle">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p>
</div>

<div id="onboarding-screen" class="screen">
    <div class="onboarding-container" id="onboarding-container">
        <div class="onboarding-slide">
            <div class="onboarding-icon">ğŸ‘¥</div>
            <h2>Ø§Ù„Ø¹Ø¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</h2>
            <p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø© Code Names Ø§Ù„Ø´Ù‡ÙŠØ±Ø© Ø¨Ù†Ø³Ø®Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©. Ø§Ù„Ø¹Ø¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†!</p>
        </div>
        
        <div class="onboarding-slide">
            <div class="onboarding-icon">ğŸ¯</div>
            <h2>ÙØ±ÙŠÙ‚Ø§Ù†ØŒ Ù‡Ø¯Ù ÙˆØ§Ø­Ø¯</h2>
            <p>ÙØ±ÙŠÙ‚ Ø£Ø­Ù…Ø± ÙˆÙØ±ÙŠÙ‚ Ø£Ø²Ø±Ù‚. ÙƒÙ„ ÙØ±ÙŠÙ‚ ÙŠØ­ØªØ§Ø¬ Ù‚Ø§Ø¦Ø¯ ÙˆÙ…Ø®Ù…Ù†ÙŠÙ†. Ø§Ø¹Ù…Ù„ Ù…Ø¹Ø§Ù‹ Ù„Ø§ÙƒØªØ´Ø§Ù ÙƒÙ„Ù…Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±!</p>
        </div>
        
        <div class="onboarding-slide">
            <div class="onboarding-icon">ğŸ’¡</div>
            <h2>Ø§Ø­Ø°Ø± Ø§Ù„Ù‚Ø§ØªÙ„!</h2>
            <p>ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ (Ø§Ù„Ù‚Ø§ØªÙ„) ÙˆØ¥Ù„Ø§ Ø®Ø³Ø± ÙØ±ÙŠÙ‚Ùƒ ÙÙˆØ±Ø§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø¨Ø°ÙƒØ§Ø¡!</p>
        </div>
    </div>
    
    <div class="onboarding-dots" id="onboarding-dots">
        <div class="onboarding-dot active"></div>
        <div class="onboarding-dot"></div>
        <div class="onboarding-dot"></div>
    </div>
    
    <div class="onboarding-footer">
        <button class="btn-skip" id="btn-skip">ØªØ®Ø·ÙŠ</button>
        <button class="btn btn-primary" id="btn-next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
</div>

<div id="auth-screen" class="screen">
    <div class="auth-header">
        <h1>ğŸ¯ Code Names</h1>
        <p class="auth-subtitle">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨</p>
    </div>
    
    <div class="card">
        <div class="input-group" id="username-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <div class="input-wrapper">
                <input type="text" id="username-input" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ø¹Ø±Ø¶">
                <span class="input-icon">ğŸ‘¤</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <div class="input-wrapper">
                <input type="email" id="email-input" placeholder="your@email.com">
                <span class="input-icon">ğŸ“§</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="input-wrapper">
                <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                <span class="input-icon">ğŸ”’</span>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary btn-full" id="auth-submit">
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            </button>
            <button class="btn btn-ghost btn-full" id="auth-toggle">
                <span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
            </button>
        </div>
    </div>
</div>

<div id="lobby-screen" class="screen">
    <div class="auth-header mb-xl">
        <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="username-display">Ø§Ù„Ù„Ø§Ø¹Ø¨</span>! ğŸ‘‹</h1>
        <p class="auth-subtitle">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</p>
    </div>
    
    <div class="lobby-actions">
        <div class="action-card">
            <div class="action-header">
                <div class="action-icon">â•</div>
                <h3>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            </div>
            <p class="action-description">Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ´Ø§Ø±Ùƒ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
            <div class="input-group">
                <input type="text" id="create-room-name" placeholder="Ø§Ø³Ù… Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" maxlength="6">
            </div>
            <button class="btn btn-accent btn-full" id="btn-create-room">
                <span class="btn-icon">ğŸš€</span>
                <span>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</span>
            </button>
        </div>
        
        <div class="action-card">
            <div class="action-header">
                <div class="action-icon">ğŸšª</div>
                <h3>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h3>
            </div>
            <p class="action-description">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
            <div class="input-group">
                <input type="text" id="join-room-code" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø«Ø§Ù„: AB12CD)" maxlength="6">
            </div>
            <button class="btn btn-primary btn-full" id="btn-join-room">
                <span class="btn-icon">â†’</span>
                <span>Ø§Ù†Ø¶Ù…Ø§Ù…</span>
            </button>
        </div>
    </div>
    
    <button class="btn btn-ghost btn-full mt-auto" id="btn-logout">
        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
    </button>
</div>

<div id="waiting-room" class="screen">
    <div class="waiting-header">
        <h2>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
        <div class="room-code-display">
            <span class="room-code-label">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©:</span>
            <span class="room-code-value" id="room-code">------</span>
        </div>
    </div>
    
    <div class="card mb-lg">
        <div class="team-selection">
            <h3>âš”ï¸ Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ ÙˆØ¯ÙˆØ±Ùƒ</h3>
            <div class="role-grid" id="role-selection">
                <button class="role-btn role-btn-red" data-team="RED" data-role="SPYMASTER">
                    <div class="role-icon-large">ğŸ‘‘</div>
                    <div class="role-name">Ù‚Ø§Ø¦Ø¯ Ø£Ø­Ù…Ø±</div>
                </button>
                
                <button class="role-btn role-btn-red" data-team="RED" data-role="GUESSER">
                    <div class="role-icon-large">ğŸ¯</div>
                    <div class="role-name">Ù…Ø®Ù…Ù† Ø£Ø­Ù…Ø±</div>
                </button>
                
                <button class="role-btn role-btn-blue" data-team="BLUE" data-role="SPYMASTER">
                    <div class="role-icon-large">ğŸ‘‘</div>
                    <div class="role-name">Ù‚Ø§Ø¦Ø¯ Ø£Ø²Ø±Ù‚</div>
                </button>
                
                <button class="role-btn role-btn-blue" data-team="BLUE" data-role="GUESSER">
                    <div class="role-icon-large">ğŸ¯</div>
                    <div class="role-name">Ù…Ø®Ù…Ù† Ø£Ø²Ø±Ù‚</div>
                </button>
            </div>
        </div>
        
        <div class="team-selection">
            <h3>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="players-count">0</span>)</h3>
            <ul class="players-list" id="players-list">
                </ul>
        </div>
    </div>
    
    <div class="waiting-actions mt-xl">
        <button class="btn btn-primary btn-full btn-large hidden" id="btn-ready-toggle" data-ready="false">
            <span class="btn-icon">âœ…</span>
            <span>Ø§Ø¶ØºØ· Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹</span>
        </button>
        <button class="btn btn-danger btn-full mt-auto" id="btn-leave-room">
            <span>Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</span>
        </button>
    </div>
</div>

<div id="game-screen" class="screen">
    <div class="player-badge hidden" id="player-role-badge">
        <div class="badge-info">
            <span id="badge-team-icon" class="badge-team"></span>
            <span id="badge-role-text" class="badge-role"></span>
        </div>
        <div class="badge-opponent-score">
            <span id="badge-opponent-score-label" style="font-size: 0.9rem; font-weight: 400;">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
            <span id="badge-opponent-score-value" class="badge-score-small"></span>
        </div>
    </div>
    
    <div class="game-header">
        <div class="game-info">
            <div class="team-score team-red">
                <div class="score-label">ğŸ”´ Ø§Ù„Ø£Ø­Ù…Ø±</div>
                <div class="score-value" id="red-score">9</div>
            </div>
            
            <div class="turn-indicator">
                <div id="current-turn">Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</div>
            </div>
            
            <div class="team-score team-blue">
                <div class="score-label">ğŸ”µ Ø§Ù„Ø£Ø²Ø±Ù‚</div>
                <div class="score-value" id="blue-score">8</div>
            </div>
        </div>
        
        <div class="clue-display" id="clue-display">
            <div class="clue-label">Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="clue-word" id="current-clue">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ­...</div>
            <div class="clue-count" id="clue-guesses">Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©: <strong>0</strong></div>
        </div>
    </div>
    
    <div class="game-board-container">
        <div class="game-grid" id="game-board">
            </div>
    </div>
    
    <div class="game-controls">
        <div id="spymaster-controls" class="hidden">
            <div class="control-input-group">
                <input type="text" id="clue-input" class="control-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­">
                <input type="number" id="count-input" class="control-input" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" min="1" max="9">
            </div>
            <button class="btn btn-accent btn-full" id="btn-give-clue">
                <span class="btn-icon">ğŸ’¡</span>
                <span>Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­</span>
            </button>
        </div>
        
        <div id="guesser-controls" class="hidden">
            <button class="btn btn-danger btn-full" id="btn-end-turn">
                <span class="btn-icon">â­</span>
                <span>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</span>
            </button>
        </div>
    </div>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-icon" id="modal-icon">â„¹ï¸</div>
        <h3 class="modal-title" id="modal-title">Ø¹Ù†ÙˆØ§Ù†</h3>
        <p class="modal-message" id="modal-message">Ø±Ø³Ø§Ù„Ø©</p>
        <div class="modal-actions">
            <button class="btn btn-primary btn-full" id="modal-confirm">Ø­Ø³Ù†Ø§Ù‹</button>
            <button class="btn btn-ghost btn-full hidden" id="modal-cancel">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// ============================================
// ğŸ¯ CONFIGURATION
// ============================================
const BACKEND_URL = 'https://codenames-arabic-server.onrender.com';
const SPLASH_DURATION = 2000;

let socket;
let userState = {
    token: localStorage.getItem('token') || null,
    userId: localStorage.getItem('userId') || null,
    username: localStorage.getItem('username') || null,
    isAuthenticated: !!localStorage.getItem('token')
};
let gameState = {};
let currentSlide = 0;

// ============================================
// ğŸ”§ UTILITY FUNCTIONS
// ============================================

// Haptic Feedback
const vibrate = (pattern = 10) => {
    if ('vibrate' in navigator) {
        navigator.vibrate(pattern);
    }
};

// Screen Management
const switchScreen = (screenId) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if (screen) {
        setTimeout(() => screen.classList.add('active'), 50);
    }
};

// Modal System
const Modal = {
    show({ icon = 'â„¹ï¸', title, message, showCancel = false, onConfirm, onCancel }) {
        vibrate(10);
        document.getElementById('modal-icon').textContent = icon;
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = message;
        
        const cancelBtn = document.getElementById('modal-cancel');
        if (showCancel) {
            cancelBtn.classList.remove('hidden');
            cancelBtn.onclick = () => {
                this.hide();
                if (onCancel) onCancel();
            };
        } else {
            cancelBtn.classList.add('hidden');
        }
        
        document.getElementById('modal-confirm').onclick = () => {
            this.hide();
            if (onConfirm) onConfirm();
        };
        
        document.getElementById('modal').classList.add('active');
    },
    
    hide() {
        document.getElementById('modal').classList.remove('active');
    },
    
    success(message, onConfirm) {
        this.show({ icon: 'âœ…', title: 'Ù†Ø¬Ø§Ø­!', message, onConfirm });
    },
    
    error(message, onConfirm) {
        this.show({ icon: 'âŒ', title: 'Ø®Ø·Ø£!', message, onConfirm });
    },
    
    confirm(message, onConfirm, onCancel) {
        this.show({ icon: 'âš ï¸', title: 'ØªØ£ÙƒÙŠØ¯', message, showCancel: true, onConfirm, onCancel });
    }
};

// ============================================
// ğŸš€ INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    // Splash Screen
    setTimeout(() => {
        const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
        if (hasSeenOnboarding) {
            if (userState.isAuthenticated) {
                connectToServer();
            } else {
                switchScreen('auth-screen');
            }
        } else {
            switchScreen('onboarding-screen');
        }
    }, SPLASH_DURATION);
    
    setupOnboarding();
    setupAuth();
    setupLobby();
    setupWaitingRoom();
    setupGame();
});

// ============================================
// ğŸ“– ONBOARDING
// ============================================
const setupOnboarding = () => {
    const container = document.getElementById('onboarding-container');
    const dots = document.getElementById('onboarding-dots');
    const btnNext = document.getElementById('btn-next');
    const btnSkip = document.getElementById('btn-skip');
    
    let touchStartX = 0;
    let touchEndX = 0;
    
    container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    });
    
    container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });
    
    const handleSwipe = () => {
        if (touchStartX - touchEndX > 50) {
            nextSlide();
        } else if (touchEndX - touchStartX > 50) {
            prevSlide();
        }
    };
    
    const updateDots = () => {
        dots.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === currentSlide);
        });
    };
    
    const nextSlide = () => {
        if (currentSlide < 2) {
            currentSlide++;
            container.scrollTo({
                left: container.clientWidth * currentSlide,
                behavior: 'smooth'
            });
            updateDots();
            vibrate(10);
        } else {
            finishOnboarding();
        }
    };
    
    const prevSlide = () => {
        if (currentSlide > 0) {
            currentSlide--;
            container.scrollTo({
                left: container.clientWidth * currentSlide,
                behavior: 'smooth'
            });
            updateDots();
            vibrate(10);
        }
    };
    
    const finishOnboarding = () => {
        localStorage.setItem('hasSeenOnboarding', 'true');
        vibrate([10, 50, 10]);
        if (userState.isAuthenticated) {
            connectToServer();
        } else {
            switchScreen('auth-screen');
        }
    };
    
    btnNext.addEventListener('click', nextSlide);
    btnSkip.addEventListener('click', finishOnboarding);
};

// ============================================
// ğŸ” AUTHENTICATION (MODIFIED: Use Email and toggle Username)
// ============================================
const setupAuth = () => {
    const submitBtn = document.getElementById('auth-submit');
    const toggleBtn = document.getElementById('auth-toggle');
    // Updated: Get the username group container and email input
    const usernameGroup = document.getElementById('username-group');
    const usernameInput = document.getElementById('username-input');
    const emailInput = document.getElementById('email-input');
    let isLogin = true;
    
    // Hide username field initially for login
    usernameGroup.classList.add('hidden');
    
    toggleBtn.addEventListener('click', () => {
        vibrate(10);
        isLogin = !isLogin;
        submitBtn.textContent = isLogin ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        toggleBtn.textContent = isLogin ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„';
        // Toggle visibility of the username group
        usernameGroup.classList.toggle('hidden', isLogin);
    });
    
    submitBtn.addEventListener('click', async () => {
        vibrate(10);
        const email = emailInput.value.trim();
        const password = document.getElementById('password-input').value;
        const username = usernameInput.value.trim();
        
        // Ensure all required fields are filled (email, password for login; + username for register)
        if (!email || !password || (!isLogin && !username)) {
            Modal.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }
        
        try {
            const endpoint = isLogin ? 'login' : 'register';
            const response = await fetch(`${BACKEND_URL}/api/users/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Pass username only if registering
                body: JSON.stringify({ email, password, username: isLogin ? undefined : username })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                userState.token = data.token;
                userState.userId = data._id;
                userState.username = data.username;
                userState.isAuthenticated = true;
                
                localStorage.setItem('token', data.token);
                localStorage.setItem('userId', data._id);
                localStorage.setItem('username', data.username);
                
                vibrate([10, 50, 10]);
                Modal.success(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${data.username}!`, () => connectToServer());
            } else {
                Modal.error(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
            }
        } catch (error) {
            Modal.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        }
    });
};

// ============================================
// ğŸŒ SERVER CONNECTION (MODIFIED: Pass userId and username for reconnection)
// ============================================
const connectToServer = async () => {
    switchScreen('splash-screen');
    
    try {
        await fetch(`${BACKEND_URL}/`);
        
        socket = io(BACKEND_URL, {
            auth: { 
                token: userState.token, 
                userId: userState.userId, // Pass userId for reconnection
                username: userState.username // Pass username for reconnection
            },
            transports: ['websocket', 'polling']
        });
        
        setupSocketListeners();
        
        socket.on('connect', () => {
            vibrate([10, 50, 10]);
            switchScreen('lobby-screen');
            document.getElementById('username-display').textContent = userState.username;
        });
        
        socket.on('connect_error', () => {
            Modal.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        });
    } catch (error) {
        Modal.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
    }
};

// ============================================
// ğŸ® SOCKET LISTENERS (MODIFIED: Added Reconnection and Leave logic)
// ============================================
const setupSocketListeners = () => {
    socket.on('roomCreated', (data) => {
        vibrate([10, 50, 10]);
        gameState = data;
        switchScreen('waiting-room');
        document.getElementById('room-code').textContent = data.code;
        updatePlayersList(data.players);
    });
    
    socket.on('roomUpdate', (players) => {
        gameState.players = players;
        updatePlayersList(players);
        updateRoleButtons(players);
    });
    
    socket.on('gameStarted', (data) => {
        vibrate([10, 50, 10, 50, 10]);
        gameState = data;
        switchScreen('game-screen');
        renderGameBoard();
        updateGameUI();
        Modal.success('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹! ğŸ®');
    });
    
    socket.on('gameUpdate', (data) => {
        Object.assign(gameState, data);
        updateGameUI();
    });
    
    socket.on('cardRevealed', ({ cardIndex, card }) => {
        vibrate(30);
        const cardEl = document.querySelector(`[data-index="${cardIndex}"]`);
        if (cardEl) {
            cardEl.classList.add('revealed', card.type);
        }
        updateScores();
    });
    
    socket.on('clueGiven', ({ clue, count }) => {
        vibrate(10);
        document.getElementById('current-clue').textContent = clue;
        document.getElementById('clue-guesses').innerHTML = `Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©: <strong>${count + 1}</strong>`;
    });
    
    socket.on('roomError', (msg) => Modal.error(msg));
    socket.on('gameError', (msg) => Modal.error(msg));
    socket.on('roleError', (msg) => Modal.error(msg));
    
    // NEW: Listener for explicit leave confirmation (Issue 5)
    socket.on('leftRoom', () => {
        switchScreen('lobby-screen');
        gameState = {}; // Clear game state
    });

    // NEW: Listener for server telling client to resume game (Reconnection)
    socket.on('resumeGame', (data) => {
        vibrate([10, 50, 10]);
        gameState = data;
        if (data.gameState === 'WAITING') {
            switchScreen('waiting-room');
            document.getElementById('room-code').textContent = data.code;
            updatePlayersList(data.players);
        } else if (data.gameState === 'IN_PROGRESS') {
            switchScreen('game-screen');
            renderGameBoard();
            updateGameUI();
        }
    });
};

// ============================================
// ğŸ  LOBBY
// ============================================
const setupLobby = () => {
    document.getElementById('btn-create-room').addEventListener('click', () => {
        vibrate(10);
        const customName = document.getElementById('create-room-name').value.toUpperCase().trim();
        socket.emit('createRoom', {
            customName,
            username: userState.username,
            userId: userState.userId
        });
    });
    
    document.getElementById('btn-join-room').addEventListener('click', () => {
        vibrate(10);
        const code = document.getElementById('join-room-code').value.toUpperCase().trim();
        if (!code) {
            Modal.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
            return;
        }
        socket.emit('joinRoom', {
            roomCode: code,
            username: userState.username,
            userId: userState.userId
        });
        
        socket.once('roomUpdate', (players) => {
            // Check if player successfully joined (roomUpdate will be fired by server on join)
            const joinedPlayer = players.find(p => p.userId === userState.userId);
            if (joinedPlayer) {
                switchScreen('waiting-room');
                document.getElementById('room-code').textContent = code;
                updatePlayersList(players);
            }
        });
    });
    
    document.getElementById('btn-logout').addEventListener('click', () => {
        Modal.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => {
            localStorage.clear();
            location.reload();
        });
    });
};

// ============================================
// â³ WAITING ROOM (REPLACED: Ready Toggle Logic)
// ============================================
const setupWaitingRoom = () => {
    document.getElementById('role-selection').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-team]');
        if (!btn) return;
        vibrate(10);
        const team = btn.dataset.team;
        const role = btn.dataset.role;
        socket.emit('setRole', { team, role });
        socket.emit('setReady', { isReady: false }); // Reset readiness on role change
    });

    // NEW READY BUTTON HANDLER (Issue 1)
    document.getElementById('btn-ready-toggle').addEventListener('click', () => {
        vibrate([10, 50, 10]);
        const isCurrentlyReady = document.getElementById('btn-ready-toggle').dataset.ready === 'true';
        const newReadyState = !isCurrentlyReady;
        socket.emit('setReady', { isReady: newReadyState });
    });
    
    document.getElementById('btn-leave-room').addEventListener('click', () => {
        Modal.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ', () => {
            socket.emit('leaveRoom'); // New event for explicit leave
        });
    });
};

const updatePlayersList = (players) => {
    const list = document.getElementById('players-list');
    const count = document.getElementById('players-count');
    count.textContent = players.length;
    
    const myPlayer = players.find(p => p.userId === userState.userId);

    list.innerHTML = players.map(p => {
        const teamIcon = p.team === 'RED' ? 'ğŸ”´' : p.team === 'BLUE' ? 'ğŸ”µ' : 'âšª';
        const roleIcon = p.role === 'SPYMASTER' ? ' ğŸ‘‘' : p.role === 'GUESSER' ? ' ğŸ¯' : '';
        const readyIcon = p.isReady ? ' âœ…' : p.team && p.role ? ' â³' : ''; // Ready status
        // NEW: Offline indicator (Issue 5)
        const statusIcon = p.isConnected === false ? ' ğŸ”´(Ø®Ø§Ø±Ø¬ Ø§Ù„Ø§ØªØµØ§Ù„)' : ''; 
        
        return `<li>${teamIcon} ${p.username}${roleIcon}${readyIcon}${statusIcon}</li>`;
    }).join('');
    
    // Update the ready button state and visibility (Issue 1, 4)
    const readyBtn = document.getElementById('btn-ready-toggle');
    const leaveBtn = document.getElementById('btn-leave-room');
    
    if (myPlayer?.team && myPlayer?.role) {
        readyBtn.classList.remove('hidden');
        const isReady = myPlayer.isReady === true;
        readyBtn.dataset.ready = isReady;
        
        if (isReady) {
            readyBtn.classList.remove('btn-primary');
            readyBtn.classList.add('btn-success');
            readyBtn.querySelector('span:last-child').textContent = 'âœ… Ø¬Ø§Ù‡Ø² (Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ù‚ÙŠØ©)';
        } else {
            readyBtn.classList.remove('btn-success');
            readyBtn.classList.add('btn-primary');
            readyBtn.querySelector('span:last-child').textContent = 'Ø§Ø¶ØºØ· Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹';
        }
        leaveBtn.classList.remove('mt-auto');
    } else {
        readyBtn.classList.add('hidden');
        leaveBtn.classList.add('mt-auto');
    }
};

const updateRoleButtons = (players) => {
    document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
    
    const currentPlayer = players.find(p => p.userId === userState.userId);
    if (currentPlayer?.team && currentPlayer?.role) {
        const selector = `[data-team="${currentPlayer.team}"][data-role="${currentPlayer.role}"]`;
        document.querySelector(selector)?.classList.add('selected');
    }
};

// ============================================
// ğŸ® GAME
// ============================================
const setupGame = () => {
    document.getElementById('btn-give-clue').addEventListener('click', () => {
        vibrate(10);
        const clue = document.getElementById('clue-input').value.trim();
        const count = parseInt(document.getElementById('count-input').value);
        
        if (!clue || !count || count < 1 || count > 9) {
            Modal.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙ„Ù…ÙŠØ­ ÙˆØ¹Ø¯Ø¯ ØµØ­ÙŠØ­');
            return;
        }
        
        socket.emit('giveClue', { clue, count });
        document.getElementById('clue-input').value = '';
        document.getElementById('count-input').value = '';
    });
    
    document.getElementById('btn-end-turn').addEventListener('click', () => {
        Modal.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±ØŸ', () => {
            vibrate(10);
            socket.emit('endTurn');
        });
    });
    
    // Swipe to end turn
    let touchY = 0;
    const boardContainer = document.querySelector('.game-board-container');
    
    boardContainer.addEventListener('touchstart', (e) => {
        touchY = e.touches[0].clientY;
    });
    
    boardContainer.addEventListener('touchend', (e) => {
        const deltaY = e.changedTouches[0].clientY - touchY;
        // Check for an aggressive downward swipe (e.g., deltaY > 100)
        if (deltaY > 100 && Math.abs(e.changedTouches[0].screenX - touchStartX) < 50) {
            const player = gameState.players?.find(p => p.userId === userState.userId);
            if (player?.role === 'GUESSER' && gameState.currentClue?.clue) {
                 Modal.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±ØŸ (Ø³Ø­Ø¨ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø³ÙÙ„)', () => {
                    vibrate(10);
                    socket.emit('endTurn');
                }, () => {
                     // Reset touch state if canceled
                });
            }
        }
    });
};

const renderGameBoard = () => {
    const board = document.getElementById('game-board');
    // NOTE: Using userId for consistency with new player object
    const player = gameState.players.find(p => p.userId === userState.userId); 
    
    board.innerHTML = gameState.board.map((card, i) => {
        const classes = ['card-word'];
        if (card.revealed) classes.push('revealed', card.type);
        
        let style = '';
        if (!card.revealed && player?.role === 'SPYMASTER') {
            const colors = {
                RED: 'var(--color-red)',
                BLUE: 'var(--color-blue)',
                INNOCENT: 'var(--color-innocent)',
                ASSASSIN: 'var(--color-assassin)'
            };
            style = `border-color: ${colors[card.type]}; border-width: 3px;`;
        }
        
        return `<div class="${classes.join(' ')}" data-index="${i}" style="${style}">${card.word}</div>`;
    }).join('');
    
    // Add click handlers
    if (player?.role === 'GUESSER') {
        board.querySelectorAll('.card-word:not(.revealed)').forEach(card => {
            card.addEventListener('click', () => {
                vibrate(20);
                const index = parseInt(card.dataset.index);
                socket.emit('makeGuess', { cardIndex: index });
            });
        });
    }
    
    updateControls(player);
};

const updateControls = (player) => {
    const spymaster = document.getElementById('spymaster-controls');
    const guesser = document.getElementById('guesser-controls');
    
    // Check if it's the player's turn
    const isMyTurn = player?.team === gameState.currentTurn;
    
    if (player?.role === 'SPYMASTER') {
        spymaster.classList.toggle('hidden', !isMyTurn);
        guesser.classList.add('hidden');
    } else if (player?.role === 'GUESSER') {
        spymaster.classList.add('hidden');
        // Guesser controls (End Turn button) are only shown if a clue has been given
        const showGuesserControls = isMyTurn && gameState.currentClue?.clue;
        guesser.classList.toggle('hidden', !showGuesserControls);
    }
};

// NEW FUNCTION (Issue 2)
const updatePlayerBadge = () => {
    const player = gameState.players.find(p => p.userId === userState.userId);
    const badge = document.getElementById('player-role-badge');
    
    if (!player || gameState.gameState !== 'IN_PROGRESS') {
        badge.classList.add('hidden');
        return;
    }
    
    badge.classList.remove('hidden');
    
    const teamText = player.team === 'RED' ? 'ğŸ”´ Ø§Ù„Ø£Ø­Ù…Ø±' : 'ğŸ”µ Ø§Ù„Ø£Ø²Ø±Ù‚';
    const roleText = player.role === 'SPYMASTER' ? 'Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚' : 'Ù…Ø®Ù…Ù†';
    const teamColor = player.team === 'RED' ? 'var(--color-red)' : 'var(--color-blue)';
    
    // Badge info (Team | Role)
    document.getElementById('badge-team-icon').textContent = teamText;
    document.getElementById('badge-team-icon').style.color = teamColor;
    document.getElementById('badge-role-text').textContent = roleText;

    // Opponent score/Role (based on spymaster or guesser)
    if (player.role === 'SPYMASTER') {
        const opponentTeam = player.team === 'RED' ? 'BLUE' : 'RED';
        const opponentScoreId = opponentTeam === 'RED' ? 'red-score' : 'blue-score';
        const opponentScore = document.getElementById(opponentScoreId).textContent;

        document.getElementById('badge-opponent-score-label').textContent = `${opponentTeam === 'RED' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}:`;
        document.getElementById('badge-opponent-score-value').textContent = `${opponentScore}`;
        document.getElementById('badge-opponent-score-value').style.color = opponentTeam === 'RED' ? 'var(--color-red)' : 'var(--color-blue)';
    } else {
        document.getElementById('badge-opponent-score-label').textContent = `Ø¯ÙˆØ±Ùƒ:`;
        document.getElementById('badge-opponent-score-value').textContent = roleText;
        document.getElementById('badge-opponent-score-value').style.color = 'var(--color-accent)';
    }
};

const updateGameUI = () => {
    if (gameState.currentTurn) {
        const turnText = gameState.currentTurn === 'RED' ? 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
        document.getElementById('current-turn').textContent = turnText;
    }
    
    updateScores();
    updatePlayerBadge(); // NEW CALL (Issue 2)

    // Ensure controls are updated after state changes
    const player = gameState.players.find(p => p.userId === userState.userId);
    updateControls(player); 
    
    if (gameState.winner) {
        vibrate([50, 100, 50, 100, 50]);
        const winnerText = gameState.winner === 'RED' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
        Modal.show({
            icon: 'ğŸ†',
            title: 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!',
            message: `ÙØ§Ø² ${winnerText}! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ‰`
        });
    }
};

const updateScores = () => {
    if (!gameState.board) return;
    
    let red = 0, blue = 0;
    gameState.board.forEach(card => {
        if (!card.revealed) {
            if (card.type === 'RED') red++;
            if (card.type === 'BLUE') blue++;
        }
    });
    
    document.getElementById('red-score').textContent = red;
    document.getElementById('blue-score').textContent = blue;
};
</script>
</body>
</html>
