<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F1419">
    <title>Code Names - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ============================================ */
/* ğŸ¨ CSS VARIABLES - Mobile-First */
/* ============================================ */
:root {
    /* Colors */
    --color-red: #FF3B5C;
    --color-red-dark: #E5315A;
    --color-blue: #2D5FF5;
    --color-blue-dark: #1E4FE0;
    
    --color-bg: #0F1419;
    --color-bg-light: #1A1F2E;
    --color-text: #FFFFFF;
    --color-secondary-text: #B0B3B8;
    --color-accent: #00FFC3; /* Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙŠØ¯Ø© */
    --color-neutral: #AAAAAA;
    --color-black: #000000;
    --color-assassin: #383838; /* Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø§ØªÙ„ */

    /* Buttons/Cards */
    --btn-primary-bg: var(--color-blue);
    --btn-primary-hover: var(--color-blue-dark);
    --btn-success-bg: #4CAF50;
    --btn-accent-bg: var(--color-accent);
    --btn-danger-bg: var(--color-red);
    
    /* Layout */
    --padding-sm: 10px;
    --padding-md: 15px;
    --padding-lg: 20px;
    --border-radius: 12px;
    
    /* Font */
    font-family: 'Cairo', sans-serif;
}

/* Base Styles */
body, html {
    margin: 0;
    padding: 0;
    background-color: var(--color-bg);
    color: var(--color-text);
    box-sizing: border-box;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Utility Classes */
.hidden { display: none !important; }
.text-center { text-align: center; }
.mt-auto { margin-top: auto; }

/* Containers */
.container {
    padding: var(--padding-md);
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
}

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--color-bg-light);
    padding: var(--padding-lg);
    border-radius: var(--border-radius);
    max-width: 90%;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

/* Header/Badges */
.header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--padding-md);
    background-color: var(--color-bg-light);
    border-bottom: 1px solid #2C3A47;
    flex-wrap: wrap;
}

.score-badge {
    padding: 5px 10px;
    border-radius: var(--border-radius);
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    min-width: 70px;
    justify-content: center;
}

.score-red { background-color: var(--color-red-dark); color: var(--color-text); }
.score-blue { background-color: var(--color-blue-dark); color: var(--color-text); }
.turn-indicator { 
    font-weight: 700; 
    font-size: 1.1em;
    color: var(--color-accent);
    text-align: center;
    flex-grow: 1;
}

/* Cards (Words) */
.game-board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--padding-sm);
    padding: var(--padding-md);
    flex-grow: 1;
    touch-action: manipulation;
}

.word-card {
    background-color: var(--color-neutral);
    color: var(--color-black);
    padding: 15px 5px;
    border-radius: var(--border-radius);
    text-align: center;
    font-weight: 700;
    font-size: 0.8em;
    line-height: 1.2;
    cursor: pointer;
    user-select: none;
    transition: transform 0.1s ease, background-color 0.3s ease;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.word-card:active {
    transform: scale(0.95);
}

/* Revealed Card Colors */
.card-red { background-color: var(--color-red); color: var(--color-text); }
.card-blue { background-color: var(--color-blue); color: var(--color-text); }
.card-neutral { background-color: var(--color-accent); color: var(--color-black); }
.card-assassin { background-color: var(--color-assassin); color: var(--color-text); }

/* Spymaster View */
.spymaster-type-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: var(--border-radius);
    opacity: 0.4; /* Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ù„ÙˆÙ† Ø§Ù„ÙØ±ÙŠÙ‚ Ø¯ÙˆÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„Ù…Ø© */
    z-index: 1;
}

.spymaster-type-indicator.red { background-color: var(--color-red); }
.spymaster-type-indicator.blue { background-color: var(--color-blue); }
.spymaster-type-indicator.neutral { background-color: var(--color-accent); }
.spymaster-type-indicator.assassin { background-color: var(--color-black); }

.word-card.spymaster-view span {
    position: relative;
    z-index: 2; /* Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù†Øµ ÙÙˆÙ‚ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù„ÙˆÙ† */
}

/* Buttons */
.btn {
    padding: 12px var(--padding-lg);
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 700;
    font-size: 1em;
    transition: background-color 0.2s ease, transform 0.1s ease;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: var(--padding-sm);
}

.btn-primary { background-color: var(--btn-primary-bg); color: var(--color-text); }
.btn-primary:hover { background-color: var(--btn-primary-hover); }

.btn-success { background-color: var(--btn-success-bg); color: var(--color-text); }
.btn-success:hover { background-color: #45a049; }

.btn-danger { background-color: var(--btn-danger-bg); color: var(--color-text); }
.btn-danger:hover { background-color: var(--color-red-dark); }

/* ğŸ†• Ø²Ø± Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ */
.btn-accent { background-color: var(--btn-accent-bg); color: var(--color-black); }
.btn-accent:hover { background-color: #00e6b5; }

/* Control Panel */
.control-panel {
    background-color: var(--color-bg-light);
    padding: var(--padding-md);
    border-top: 1px solid #2C3A47;
}

/* Input/Forms */
.input-group {
    margin-bottom: var(--padding-sm);
    display: flex;
    gap: var(--padding-sm);
}

.input-group input, .input-group select {
    padding: 10px;
    border-radius: var(--border-radius);
    border: 1px solid #333;
    background-color: #222;
    color: var(--color-text);
    flex-grow: 1;
}

/* Waiting Room */
.waiting-room {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 80px); /* ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    padding-bottom: 20px;
}

.waiting-room h2 {
    color: var(--color-accent);
    margin-top: 0;
    margin-bottom: var(--padding-md);
}

.waiting-room-controls {
    margin-top: auto;
    padding-top: var(--padding-lg);
}

.players-list {
    list-style: none;
    padding: 0;
    margin: var(--padding-md) 0;
    background-color: #1A1A1A;
    border-radius: var(--border-radius);
}

.players-list li {
    padding: 10px var(--padding-md);
    border-bottom: 1px solid #2C2C2C;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.players-list li:last-child {
    border-bottom: none;
}

/* Roles Grid */
.roles-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--padding-sm);
    margin-top: var(--padding-md);
}

.role-btn {
    padding: 15px 10px;
    border-radius: var(--border-radius);
    text-align: center;
    font-weight: 700;
    cursor: pointer;
    background-color: #2A2A2A;
    transition: background-color 0.2s ease, transform 0.1s ease;
    border: 2px solid transparent;
}

.role-btn:active { transform: scale(0.98); }

.role-red { color: var(--color-red); }
.role-blue { color: var(--color-blue); }

.role-btn.selected {
    border-color: var(--color-text);
    background-color: #3A3A3A;
}

    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <h1 id="modal-icon"></h1>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button id="modal-close-btn" class="btn btn-primary mt-3">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="login-screen" class="container text-center">
        <h1>ÙƒÙˆØ¯ Ù†ÙŠÙ…Ø² Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h1>
        <div class="input-group">
            <input type="text" id="username-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
        </div>
        <button id="btn-create-room" class="btn btn-primary">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <div class="input-group" style="margin-top: 15px;">
            <input type="text" id="roomcode-input" placeholder="Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: ABCD)" maxlength="4" style="text-transform: uppercase;">
            <button id="btn-join-room" class="btn btn-success">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>
        <div class="text-center mt-3">
             <input type="checkbox" id="ai-toggle">
             <label for="ai-toggle" style="color: var(--color-secondary-text);">Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚)</label>
        </div>
    </div>

    <div id="waiting-room-screen" class="container waiting-room hidden">
        <h2 id="room-code-display" class="text-center"></h2>
        
        <div class="text-center" style="margin-bottom: 20px;">
            <p style="color: var(--color-secondary-text);">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©: <span id="players-count" style="font-weight: bold;">0</span></p>
            <ul id="players-list" class="players-list">
                </ul>
        </div>

        <h3>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ ÙˆØ¯ÙˆØ±Ùƒ:</h3>
        <div class="roles-grid">
            <div id="role-red-spymaster" class="role-btn role-red" data-team="RED" data-role="SPYMASTER">
                Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø© <br> (Ø£Ø­Ù…Ø±) ğŸ‘‘
            </div>
            <div id="role-red-guesser" class="role-btn role-red" data-team="RED" data-role="GUESSER">
                Ø§Ù„Ù…Ø®Ù…Ù‘Ù† <br> (Ø£Ø­Ù…Ø±) ğŸ¯
            </div>
            
            <div id="role-blue-spymaster" class="role-btn role-blue" data-team="BLUE" data-role="SPYMASTER">
                Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø© <br> (Ø£Ø²Ø±Ù‚) ğŸ‘‘
            </div>
            <div id="role-blue-guesser" class="role-btn role-blue" data-team="BLUE" data-role="GUESSER">
                Ø§Ù„Ù…Ø®Ù…Ù‘Ù† <br> (Ø£Ø²Ø±Ù‚) ğŸ¯
            </div>
        </div>
        
        <div class="waiting-room-controls">
             <button id="btn-ready-toggle" class="btn btn-primary hidden" data-ready="false" data-action="SET_READY">
                <span>âš ï¸</span> <span>Ø§Ø¶ØºØ· Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹</span>
            </button>
            <button id="btn-leave-room" class="btn btn-danger mt-auto">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
        </div>
    </div>

    <div id="game-screen" class="container hidden">
        <div class="header-bar">
            <div id="score-blue" class="score-badge score-blue">
                <span id="score-blue-value">0</span>
                <span>ğŸ”µ</span>
            </div>
            
            <div class="turn-indicator" id="current-turn">...</div>
            
            <div id="score-red" class="score-badge score-red">
                <span>ğŸ”´</span>
                <span id="score-red-value">0</span>
            </div>
        </div>
        
        <div class="header-bar" style="margin-top: 10px; border-radius: 12px; background-color: #222;">
            <div class="score-badge" style="background-color: transparent;">
                <span id="badge-my-role-label" style="color: var(--color-secondary-text);">Ø¯ÙˆØ±Ùƒ:</span>
                <span id="badge-my-role-value" style="font-weight: 700; color: var(--color-text);"></span>
            </div>
            <div id="player-status-badge" class="score-badge" style="background-color: transparent;">
                 <span id="badge-opponent-score-label" style="color: var(--color-secondary-text);">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</span>
                 <span id="badge-opponent-score-value" style="font-weight: 700;"></span>
            </div>
        </div>
        
        <div id="game-board" class="game-board">
            </div>

        <div id="control-panel" class="control-panel">
            <div id="clue-input-controls">
                <p id="turn-status-message" class="text-center" style="margin-bottom: 10px; font-weight: 600;"></p>
                <div class="input-group">
                    <input type="text" id="clue-word-input" placeholder="Ø§Ù„ØªÙ„Ù…ÙŠØ­ (ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø©)" maxlength="20" dir="ltr" style="text-align: left;">
                    <select id="clue-count-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="0">âˆ</option>
                    </select>
                </div>
                <button id="btn-give-clue" class="btn btn-success">Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­</button>
            </div>

            <div id="guessing-controls" class="hidden">
                 <button id="btn-end-turn" class="btn btn-danger">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</button>
            </div>
        </div>
    </div>

<script>
    // ============================================
    // âš™ï¸ INITIALIZATION AND GLOBALS
    // ============================================

    const socket = io();
    const storageKey = 'codenames_user_data';

    let userState = {
        userId: localStorage.getItem(storageKey + '_id') || generateUUID(),
        username: localStorage.getItem(storageKey + '_name') || '',
        roomCode: ''
    };

    let gameState = {
        players: [],
        board: [],
        currentTurn: null,
        gameState: 'WAITING',
        clue: null,
        guessesLeft: 0,
        turnPhase: 'CLUE_GIVING',
        winner: null,
        isAIGame: false
    };

    // Save user state immediately if it's new
    if (!localStorage.getItem(storageKey + '_id')) {
        localStorage.setItem(storageKey + '_id', userState.userId);
    }
    
    // ============================================
    // ğŸ› ï¸ UTILITY FUNCTIONS
    // ============================================

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù…Ù‡Ø§
    const vibrate = (pattern) => {
        if (navigator.vibrate) {
            navigator.vibrate(pattern);
        }
    };

    // ÙƒØ§Ø¦Ù† Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©)
    const Modal = {
        show: ({ icon, title, message }) => {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').style.display = 'flex';
        },
        hide: () => {
            document.getElementById('modal-overlay').style.display = 'none';
        }
    };
    
    // ===============================================
    // âœ… Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© - Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ===============================================
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ØºØ±ÙØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.
     * Ø§Ù„Ø´Ø±ÙˆØ·:
     * 1. ÙˆØ¬ÙˆØ¯ 4 Ø£Ø¯ÙˆØ§Ø± Ø£Ø³Ø§Ø³ÙŠØ© (Ù‚Ø§Ø¦Ø¯ Ø£Ø­Ù…Ø±ØŒ Ù…Ø®Ù…Ù† Ø£Ø­Ù…Ø±ØŒ Ù‚Ø§Ø¦Ø¯ Ø£Ø²Ø±Ù‚ØŒ Ù…Ø®Ù…Ù† Ø£Ø²Ø±Ù‚)
     * (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ø¯ Ø£Ø²Ø±Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© AI)
     * 2. ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø§Ø®ØªØ§Ø±ÙˆØ§ Ø¯ÙˆØ±Ø§Ù‹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†ÙˆØ§ Ø¬Ø§Ù‡Ø²ÙŠÙ† (isReady: true).
     */
    const isRoomReadyToStart = (players) => {
        const playersWithRoles = players.filter(p => p.team && p.role);
        
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©
        const rolesFilled = {
            'RED_SPYMASTER': false,
            'RED_GUESSER': false,
            'BLUE_SPYMASTER': false,
            'BLUE_GUESSER': false
        };

        playersWithRoles.forEach(p => {
            rolesFilled[`${p.team}_${p.role}`] = true;
        });

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© AIØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù‚Ø§Ø¦Ø¯ Ø£Ø²Ø±Ù‚ Ø¨Ø´Ø±ÙŠ
        const needsBlueSpymaster = !gameState.isAIGame; 
        
        if (!rolesFilled['RED_SPYMASTER'] || !rolesFilled['RED_GUESSER'] || !rolesFilled['BLUE_GUESSER']) {
             return false; // Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙÙ‚ÙˆØ¯Ø©
        }
        
        if (needsBlueSpymaster && !rolesFilled['BLUE_SPYMASTER']) {
            return false; // Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø£Ø²Ø±Ù‚ Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Ù„Ø¹Ø¨Ø© ØºÙŠØ± AI
        }

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ø§Ø®ØªØ§Ø±ÙˆØ§ Ø¯ÙˆØ±Ø§Ù‹ Ø¬Ø§Ù‡Ø²ÙŠÙ†
        const allReady = playersWithRoles.every(p => p.isReady === true);
        
        return allReady;
    };
    
    // ============================================
    // ğŸ–¥ï¸ UI MANAGEMENT
    // ============================================

    const showScreen = (screenId) => {
        ['login-screen', 'waiting-room-screen', 'game-screen'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    };
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    // ğŸ†• ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© ÙˆØ²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨"
    const updatePlayersList = (players) => {
        gameState.players = players; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        const list = document.getElementById('players-list');
        const count = document.getElementById('players-count');
        count.textContent = players.length;
        const myPlayer = players.find(p => p.userId === userState.userId);

        // **ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ØºØ±ÙØ©**
        const roomReady = isRoomReadyToStart(players); 

        list.innerHTML = players.map(p => {
            const teamIcon = p.team === 'RED' ? 'ğŸ”´' : p.team === 'BLUE' ? 'ğŸ”µ' : 'âšª';
            const roleText = p.role === 'SPYMASTER' ? 'Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø©' : p.role === 'GUESSER' ? 'Ø§Ù„Ù…Ø®Ù…Ù‘Ù†' : 'Ù„Ù… ÙŠØ®ØªØ± Ø¯ÙˆØ±Ø§Ù‹';
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
            const readyIcon = p.isReady ? ' âœ…' : (p.team && p.role ? ' â³' : '');
            const statusIcon = p.isConnected === false ? ' ğŸ”´(Ø®Ø§Ø±Ø¬ Ø§Ù„Ø§ØªØµØ§Ù„)' : '';
            return `<li>${teamIcon} ${p.username} - ${roleText}${readyIcon}${statusIcon}</li>`;
        }).join('');

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± "Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©"
        const readyBtn = document.getElementById('btn-ready-toggle');
        const leaveBtn = document.getElementById('btn-leave-room');
        const rolesGrid = document.querySelector('.roles-grid');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        rolesGrid.querySelectorAll('.role-btn').forEach(btn => {
            const team = btn.dataset.team;
            const role = btn.dataset.role;
            const isTaken = players.some(p => p.team === team && p.role === role && p.userId !== userState.userId);
            
            btn.classList.remove('selected');
            if (myPlayer && myPlayer.team === team && myPlayer.role === role) {
                btn.classList.add('selected');
            }
            btn.disabled = isTaken;
            btn.style.opacity = isTaken ? '0.5' : '1';
        });


        if (myPlayer?.team && myPlayer?.role) {
            readyBtn.classList.remove('hidden');
            const isReady = myPlayer.isReady === true;
            readyBtn.dataset.ready = isReady;

            if (roomReady) {
                // **Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„ÙƒÙ„ Ø¬Ø§Ù‡Ø²ØŒ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨"**
                readyBtn.classList.remove('btn-primary', 'btn-success');
                readyBtn.classList.add('btn-accent'); 
                readyBtn.querySelector('span:first-child').textContent = 'â–¶ï¸';
                readyBtn.querySelector('span:last-child').textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨';
                readyBtn.dataset.action = 'START_GAME'; // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                
            } else if (isReady) {
                // Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù‚ÙŠØ©
                readyBtn.classList.remove('btn-primary', 'btn-accent');
                readyBtn.classList.add('btn-success');
                readyBtn.querySelector('span:first-child').textContent = 'âœ…';
                readyBtn.querySelector('span:last-child').textContent = 'Ø¬Ø§Ù‡Ø² (Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ù‚ÙŠØ©)';
                readyBtn.dataset.action = 'SET_UNREADY'; 
                
            } else {
                // Ø­Ø§Ù„Ø©: ØºÙŠØ± Ø¬Ø§Ù‡Ø² (Ø§Ø¶ØºØ· Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹)
                readyBtn.classList.remove('btn-success', 'btn-accent');
                readyBtn.classList.add('btn-primary');
                readyBtn.querySelector('span:first-child').textContent = 'âš ï¸';
                readyBtn.querySelector('span:last-child').textContent = 'Ø§Ø¶ØºØ· Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø§Ù‹';
                readyBtn.dataset.action = 'SET_READY';
            }

            leaveBtn.classList.remove('mt-auto');
        } else {
            readyBtn.classList.add('hidden');
            leaveBtn.classList.add('mt-auto');
        }
    };


    const updateGameUI = () => {
        if (gameState.currentTurn) {
            const turnText = gameState.currentTurn === 'RED' ? 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
            document.getElementById('current-turn').textContent = turnText;
        }
        
        updateScores();
        updatePlayerBadge(); 
        updateGameBoard();

        // Ensure controls are updated after state changes
        const player = gameState.players.find(p => p.userId === userState.userId);
        updateControls(player); 
        
        if (gameState.winner) {
            vibrate([50, 100, 50, 100, 50]);
            const winnerText = gameState.winner === 'RED' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
            Modal.show({
                icon: 'ğŸ†',
                title: 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!',
                message: `ÙØ§Ø² ${winnerText}! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ‰`
            });
        }
    };
    
    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­ Ø§Ù„ÙƒÙ„Ù…Ø§Øª
    const updateGameBoard = () => {
        const boardContainer = document.getElementById('game-board');
        const myPlayer = gameState.players.find(p => p.userId === userState.userId);
        const isSpymaster = myPlayer && myPlayer.role === 'SPYMASTER';
        
        if (!gameState.board || gameState.board.length === 0) {
            boardContainer.innerHTML = '<h3>Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­ Ø§Ù„ÙƒÙ„Ù…Ø§Øª...</h3>';
            return;
        }
        
        boardContainer.innerHTML = gameState.board.map(card => {
            let cardClass = '';
            let innerContent = `<span>${card.word}</span>`;
            let spymasterOverlay = '';
            
            // ØªØ·Ø¨ÙŠÙ‚ ÙØ¦Ø© Ù„ÙˆÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ´Ù
            if (card.revealed) {
                cardClass = `card-${card.type.toLowerCase()}`;
            } else if (isSpymaster) {
                // Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø©
                cardClass = 'spymaster-view';
                spymasterOverlay = `<div class="spymaster-type-indicator ${card.type.toLowerCase()}"></div>`;
            }
            
            return `
                <div class="word-card ${cardClass}" data-word="${card.word}" data-revealed="${card.revealed}">
                    ${spymasterOverlay}
                    ${innerContent}
                </div>
            `;
        }).join('');

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ù„Ù„Ù…Ø®Ù…Ù‘Ù†ÙŠÙ†)
        if (!isSpymaster && gameState.turnPhase === 'GUESSING') {
            document.querySelectorAll('.word-card').forEach(cardEl => {
                if (cardEl.dataset.revealed === 'false') {
                    cardEl.addEventListener('click', handleCardClick);
                }
            });
        }
    };
    
    const updateScores = () => {
        if (!gameState.board) return;
        
        let redTotal = 9, blueTotal = 8; // Ø§ÙØªØ±Ø§Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©
        let redRevealed = 0, blueRevealed = 0;
        
        gameState.board.forEach(card => {
            if (card.type === 'RED') redTotal--;
            if (card.type === 'BLUE') blueTotal--;
            
            if (card.revealed) {
                if (card.type === 'RED') redRevealed++;
                if (card.type === 'BLUE') blueRevealed++;
            }
        });

        const redRemaining = redTotal + redRevealed; // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        const blueRemaining = blueTotal + blueRevealed;

        document.getElementById('score-red-value').textContent = redRemaining;
        document.getElementById('score-blue-value').textContent = blueRemaining;
    };
    
    const updatePlayerBadge = () => {
        const myPlayer = gameState.players.find(p => p.userId === userState.userId);
        if (!myPlayer) return;

        const roleText = myPlayer.role === 'SPYMASTER' ? 'Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø© ğŸ‘‘' : 'Ø§Ù„Ù…Ø®Ù…Ù‘Ù† ğŸ¯';
        document.getElementById('badge-my-role-value').textContent = roleText;

        const opponentScoreLabel = document.getElementById('badge-opponent-score-label');
        const opponentScoreValue = document.getElementById('badge-opponent-score-value');
        
        if (myPlayer.role === 'SPYMASTER') {
            opponentScoreLabel.textContent = `ÙƒÙ„Ù…Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:`;
            // Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ®Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©)
            let myTeamRemaining = 0;
            const myTeamType = myPlayer.team === 'RED' ? 'RED' : 'BLUE';

            gameState.board.forEach(card => {
                if (!card.revealed && card.type === myTeamType) {
                    myTeamRemaining++;
                }
            });
            opponentScoreValue.textContent = myTeamRemaining;
            opponentScoreValue.style.color = myPlayer.team === 'RED' ? 'var(--color-red)' : 'var(--color-blue)';
            
        } else if (myPlayer.role === 'GUESSER') {
            opponentScoreLabel.textContent = `ØªØ®Ù…ÙŠÙ†Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©:`;
            opponentScoreValue.textContent = gameState.guessesLeft > 0 ? gameState.guessesLeft : 'Ø§Ù†ØªØ¸Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ­';
            opponentScoreValue.style.color = 'var(--color-accent)';
        }
    };
    
    const updateControls = (player) => {
        const clueControls = document.getElementById('clue-input-controls');
        const guessingControls = document.getElementById('guessing-controls');
        const statusMessage = document.getElementById('turn-status-message');
        
        if (!player || gameState.gameState !== 'IN_PROGRESS') {
            clueControls.classList.add('hidden');
            guessingControls.classList.add('hidden');
            statusMessage.classList.add('hidden');
            return;
        }

        const isMyTurn = gameState.currentTurn === player.team;
        const isSpymaster = player.role === 'SPYMASTER';

        statusMessage.classList.remove('hidden');
        
        if (isMyTurn) {
            if (isSpymaster && gameState.turnPhase === 'CLUE_GIVING') {
                // Ø¯ÙˆØ± Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø© Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­
                clueControls.classList.remove('hidden');
                guessingControls.classList.add('hidden');
                statusMessage.textContent = 'Ø¯ÙˆØ±Ùƒ Ù„Ø¥Ø¹Ø·Ø§Ø¡ ØªÙ„Ù…ÙŠØ­';
                
            } else if (!isSpymaster && gameState.turnPhase === 'GUESSING') {
                // Ø¯ÙˆØ± Ø§Ù„Ù…Ø®Ù…Ù† Ù„Ù„ØªØ®Ù…ÙŠÙ†
                clueControls.classList.add('hidden');
                guessingControls.classList.remove('hidden');
                statusMessage.textContent = `ØªØ®Ù…ÙŠÙ†: ${gameState.clue?.word || '...'} (${gameState.guessesLeft} Ù…Ø­Ø§ÙˆÙ„Ø§Øª)`;
                
            } else {
                 // Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ù…Ø§ ØªÙ„Ù…ÙŠØ­ Ø£Ùˆ ØªØ®Ù…ÙŠÙ†
                clueControls.classList.add('hidden');
                guessingControls.classList.add('hidden');
                if (gameState.turnPhase === 'CLUE_GIVING') {
                    statusMessage.textContent = 'Ø§Ù†ØªØ¸Ø± ØªÙ„Ù…ÙŠØ­ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø´ÙŠÙØ±Ø©';
                } else {
                    statusMessage.textContent = 'Ø§Ù†ØªØ¸Ø± ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù…Ø®Ù…Ù‘Ù†';
                }
            }
        } else {
            // Ù„ÙŠØ³ Ø¯ÙˆØ± ÙØ±ÙŠÙ‚ÙŠ
            clueControls.classList.add('hidden');
            guessingControls.classList.add('hidden');
            statusMessage.textContent = 'Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±';
        }
    };


    // ============================================
    // ğŸšª WAITING ROOM LOGIC
    // ============================================

    const setupWaitingRoom = () => {
        showScreen('waiting-room-screen');
        document.getElementById('room-code-display').textContent = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${userState.roomCode}`;

        // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±/Ø§Ù„ÙØ±ÙŠÙ‚
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.onclick = () => {
                vibrate(10);
                const team = btn.dataset.team;
                const role = btn.dataset.role;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¯ÙˆØ± ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²
                const isTaken = gameState.players.some(p => p.team === team && p.role === role && p.userId !== userState.userId);
                if (isTaken) {
                    Modal.show({
                        icon: 'â›”',
                        title: 'Ø§Ù„Ø¯ÙˆØ± Ù…Ø­Ø¬ÙˆØ²',
                        message: 'Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ± Ù…Ø­Ø¬ÙˆØ² Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±.'
                    });
                    return;
                }
                
                socket.emit('setRole', { team, role });
            };
        });
        
        // ğŸ†• ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø§Ù„Ø²Ø± 'btn-ready-toggle'
        document.getElementById('btn-ready-toggle').addEventListener('click', () => {
            vibrate(10);
            const readyBtn = document.getElementById('btn-ready-toggle');
            const action = readyBtn.dataset.action; // Ù‚Ø±Ø§Ø¡Ø© Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

            if (action === 'START_GAME') {
                // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŒ Ø¢Ø®Ø± Ø¶ØºØ·Ø© ØªØ±Ø³Ù„ setReady: true 
                // ÙˆÙŠÙ‚ÙˆÙ… Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (ÙƒÙ…Ø§ ÙÙŠ gameController.js)
                socket.emit('setReady', { isReady: true });
                
            } else if (action === 'SET_READY') {
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¥Ù„Ù‰ Ø¬Ø§Ù‡Ø²
                socket.emit('setReady', { isReady: true });
                
            } else if (action === 'SET_UNREADY') {
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø¬Ø§Ù‡Ø² Ø¥Ù„Ù‰ ØºÙŠØ± Ø¬Ø§Ù‡Ø²
                socket.emit('setReady', { isReady: false });
            }
        });

        // Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©
        document.getElementById('btn-leave-room').onclick = () => {
            vibrate(10);
            socket.emit('leaveRoom', { roomCode: userState.roomCode });
            userState.roomCode = '';
            showScreen('login-screen');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ socket Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            window.location.reload(); 
        };
    };
    
    // ============================================
    // ğŸ® GAME ACTIONS
    // ============================================

    const handleCardClick = (event) => {
        vibrate(10);
        const cardEl = event.currentTarget;
        const word = cardEl.dataset.word;
        
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ®Ù…ÙŠÙ† ÙƒÙ„Ù…Ø©: ${word}ØŸ`)) {
            socket.emit('guessWord', { word });
        }
    };

    const setupGameControls = () => {
        // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­
        document.getElementById('btn-give-clue').onclick = () => {
            vibrate(10);
            const word = document.getElementById('clue-word-input').value.trim();
            const count = parseInt(document.getElementById('clue-count-select').value);
            
            if (!word) {
                Modal.show({ icon: 'âš ï¸', title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­.' });
                return;
            }
            if (count < 0 || isNaN(count)) {
                 Modal.show({ icon: 'âš ï¸', title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„ØªØ®Ù…ÙŠÙ†Ø§Øª.' });
                return;
            }
            
            socket.emit('giveClue', { word, count });
        };
        
        // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
        document.getElementById('btn-end-turn').onclick = () => {
            vibrate(10);
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø¯ÙˆØ± Ø§Ù„ØªØ®Ù…ÙŠÙ†ØŸ Ø³ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±.')) {
                socket.emit('endTurn');
            }
        };
    };


    // ============================================
    // ğŸŒ SOCKET.IO HANDLERS
    // ============================================
    
    // Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
    socket.on('connect', () => {
        console.log('Connected to server');
        if (userState.username && userState.roomCode) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø£Ùˆ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©
            socket.emit('joinRoom', { 
                roomCode: userState.roomCode, 
                userId: userState.userId, 
                username: userState.username 
            });
        } else {
            // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
            showScreen('login-screen');
        }
    });

    // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±
    socket.on('roleError', (message) => {
        vibrate([100, 50, 100]);
        Modal.show({
            icon: 'âŒ',
            title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±',
            message: message
        });
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)
    socket.on('roomUpdate', (players) => {
        updatePlayersList(players);
    });

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    socket.on('gameStarted', (data) => {
        vibrate([50, 50, 50, 50, 50]);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø¹Ø¨Ø©
        gameState = {
            ...gameState,
            ...data, // Ø¯Ù…Ø¬ ÙƒÙ„ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù„Ø¹Ø¨Ø©
            isAIGame: data.isAIGame || false
        };
        showScreen('game-screen');
        updateGameUI();
        setupGameControls(); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù†Ù‚Ø±
    });

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„ØªÙ„Ù…ÙŠØ­ØŒ Ø§Ù„ØªØ®Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©ØŒ Ø§Ù„Ø¯ÙˆØ±)
    socket.on('gameUpdate', (data) => {
        gameState = {
            ...gameState,
            ...data
        };
        updateGameUI();
    });

    // ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ ØªØ®Ù…ÙŠÙ† ÙƒÙ„Ù…Ø©
    socket.on('boardUpdate', ({ board, winner, lastGuessedWord }) => {
        gameState.board = board;
        gameState.winner = winner;
        
        if (lastGuessedWord) {
            vibrate(150);
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù‡Ù†Ø§ Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªØ®Ù…ÙŠÙ†Ù‡Ø§
        }
        
        updateGameUI();
    });

    // ============================================
    // ğŸ“¤ LOGIN/ROOM BUTTON HANDLERS
    // ============================================
    
    // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    const setupLoginScreen = () => {
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        document.getElementById('username-input').value = userState.username;

        // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
        document.getElementById('btn-create-room').onclick = () => {
            vibrate(10);
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                 Modal.show({ icon: 'âš ï¸', title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….' });
                 return;
            }
            userState.username = username;
            localStorage.setItem(storageKey + '_name', username);
            
            const isAIGame = document.getElementById('ai-toggle').checked;
            gameState.isAIGame = isAIGame; // Ø­ÙØ¸ Ø­Ø§Ù„Ø© AI
            
            socket.emit('createRoom', { userId: userState.userId, username, isAIGame });
        };

        // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©
        document.getElementById('btn-join-room').onclick = () => {
            vibrate(10);
            const username = document.getElementById('username-input').value.trim();
            const roomCode = document.getElementById('roomcode-input').value.trim().toUpperCase();
            
            if (!username || !roomCode || roomCode.length !== 4) {
                 Modal.show({ icon: 'âš ï¸', title: 'Ø®Ø·Ø£', message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ±Ù…Ø² ØºØ±ÙØ© ØµØ­ÙŠØ­ (4 Ø£Ø­Ø±Ù).' });
                 return;
            }
            userState.username = username;
            localStorage.setItem(storageKey + '_name', username);
            
            socket.emit('joinRoom', { userId: userState.userId, username, roomCode });
        };
    };

    // Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­
    socket.on('roomCreated', (roomCode) => {
        userState.roomCode = roomCode;
        setupWaitingRoom();
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­
    socket.on('roomJoined', (data) => {
        userState.roomCode = data.roomCode;
        gameState.isAIGame = data.isAIGame;
        updatePlayersList(data.players);
        setupWaitingRoom();
    });

    // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØºØ±ÙØ©
    socket.on('roomError', (message) => {
        vibrate([100, 50, 100]);
        Modal.show({
            icon: 'âŒ',
            title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØºØ±ÙØ©',
            message: message
        });
    });

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        setupLoginScreen();
        document.getElementById('modal-close-btn').onclick = Modal.hide;
        
        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØºØ±ÙØ©
        if (!userState.roomCode) {
            showScreen('login-screen');
        }
    });

</script>
</body>
</html>
