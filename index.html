<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F1419">
    <title>Code Names - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
/* ============================================ */
/* ğŸ¨ CSS VARIABLES - Mobile-First */
/* ============================================ */
:root {
    /* Colors */
    --color-red: #FF3B5C;
    --color-red-dark: #E5315A;
    --color-blue: #2D5FF5;
    --color-blue-dark: #1E4FE0;
    
    --color-bg: #0F1419;
    --color-bg-light: #1A1F2E;
    --color-card-bg: #2B3047;
    --color-card-text: #FFFFFF;
    --color-text: #FFFFFF;
    --color-text-muted: #99A1C5;
    --color-accent: #6C5CE7;
    --color-accent-dark: #5C4CD7;
    --color-success: #00B894;
    --color-danger: #FF3B5C;
    --color-neutral: #C7C9D2;
    --color-assassin: #000000;
    
    /* Spacing */
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;

    /* Radius */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-full: 9999px;

    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);

    /* Typography */
    --font-family: 'Cairo', sans-serif;
    
    /* Touch Target */
    --touch-comfortable: 48px;
    
    /* Safe Area */
    --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body, html {
    background-color: var(--color-bg);
    color: var(--color-text);
    font-family: var(--font-family);
    -webkit-tap-highlight-color: transparent;
    height: 100%;
    min-height: 100vh;
    overflow: hidden; /* Prevent body scroll */
}

/* ============================================ */
/* ğŸ“± General Layout & Screens */
/* ============================================ */
#app-container {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding-top: env(safe-area-inset-top, 0px);
}

.screen {
    flex-grow: 1;
    overflow-y: auto;
    padding: var(--space-lg) var(--space-md);
    display: flex;
    flex-direction: column;
    /* NEW: Generous bottom padding to ensure all content, especially in waiting-room, is visible */
    padding-bottom: calc(var(--safe-bottom) + var(--space-xl) * 2) !important; 
}

.hidden {
    display: none !important;
}

.screen-header {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.screen-header h1 {
    font-size: 2rem;
    color: var(--color-accent);
}

/* ============================================ */
/* ğŸ•¹ï¸ Components */
/* ============================================ */

/* Buttons */
.btn {
    padding: var(--space-sm) var(--space-md);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 1rem;
    font-weight: 700;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    min-height: var(--touch-comfortable);
}

.btn-primary {
    background-color: var(--color-accent);
    color: var(--color-text);
}

.btn-primary:hover:not(:disabled) {
    background-color: var(--color-accent-dark);
}

.btn-success {
    background-color: var(--color-success);
    color: var(--color-bg);
}

.btn-success:hover:not(:disabled) {
    background-color: #00967a;
}

.btn-danger {
    background-color: var(--color-danger);
    color: var(--color-text);
}

.btn-danger:hover:not(:disabled) {
    background-color: var(--color-red-dark);
}

.btn-accent {
    background-color: var(--color-accent);
    color: var(--color-text);
}

.btn-full {
    width: 100%;
}

.btn-large {
    font-size: 1.1rem;
    padding: var(--space-md) var(--space-lg);
}

.btn:disabled {
    background-color: var(--color-bg-light);
    color: var(--color-text-muted);
    cursor: not-allowed;
}

.mt-auto {
    margin-top: auto;
}

/* Inputs */
.input-group {
    margin-bottom: var(--space-lg);
}

.input-label {
    display: block;
    margin-bottom: var(--space-sm);
    font-weight: 600;
}

.input-text, .control-input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    background-color: var(--color-bg-light);
    border: 1px solid var(--color-bg-light);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: 1rem;
    font-family: var(--font-family);
    min-height: var(--touch-comfortable);
}

.input-text:focus, .control-input:focus {
    outline: none;
    border-color: var(--color-accent);
}

/* ============================================ */
/* ğŸš€ Onboarding Screen */
/* ============================================ */
#onboarding-screen {
    padding: 0;
    overflow: hidden;
}

#onboarding-container {
    display: flex;
    overflow-x: hidden;
    scroll-snap-type: x mandatory;
    width: 100%;
    height: 100%;
}

.onboarding-slide {
    flex-shrink: 0;
    width: 100%;
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    scroll-snap-align: start;
    min-height: 100%;
}

.onboarding-slide h2 {
    font-size: 2.2rem;
    margin-bottom: var(--space-md);
    color: var(--color-accent);
}

.onboarding-slide p {
    font-size: 1.1rem;
    color: var(--color-text-muted);
    max-width: 400px;
    margin-bottom: var(--space-lg);
}

.onboarding-slide .icon {
    font-size: 4rem;
    margin-bottom: var(--space-xl);
}

.onboarding-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--space-md);
    padding-bottom: calc(var(--safe-bottom) + var(--space-md));
    background: var(--color-bg);
    display: flex;
    justify-content: space-between;
    gap: var(--space-md);
    z-index: 10;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
}

.btn-skip {
    background: none;
    color: var(--color-text-muted);
    font-weight: 400;
    padding: 0;
    min-height: var(--touch-comfortable);
    flex-grow: 1;
}

.onboarding-dots {
    position: absolute;
    bottom: calc(100px + var(--safe-bottom)); /* Position above the footer */
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: var(--space-sm);
}

.onboarding-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background-color: var(--color-bg-light);
    transition: background-color 0.3s, width 0.3s;
}

.onboarding-dot.active {
    width: 20px;
    background-color: var(--color-accent);
}

/* ============================================ */
/* ğŸšª Lobby & Waiting Room Screens */
/* ============================================ */

/* Waiting Room Specific */
#room-code-display {
    text-align: center;
    margin-bottom: var(--space-lg);
}

#room-code-display h2 {
    font-size: 1.2rem;
    color: var(--color-text-muted);
}

#room-code-display p {
    font-size: 3rem;
    font-weight: 800;
    color: var(--color-accent);
    margin-top: var(--space-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
}

#room-code-display button {
    background: none;
    border: none;
    color: var(--color-accent);
    font-size: 1rem;
    cursor: pointer;
    padding: var(--space-sm);
}

/* Player List */
#players-section {
    background-color: var(--color-bg-light);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-lg);
    flex-grow: 1;
    overflow-y: auto;
}

#players-section h3 {
    margin-bottom: var(--space-md);
    font-size: 1.1rem;
    color: var(--color-text);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#players-list {
    list-style: none;
}

#players-list li {
    padding: var(--space-sm) 0;
    border-bottom: 1px dashed var(--color-bg);
    font-size: 1rem;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: var(--space-sm);
}

#players-list li:last-child {
    border-bottom: none;
}

.offline-player {
    opacity: 0.6;
}

/* Team and Role Selection */
.selection-group {
    margin-bottom: var(--space-lg);
}

.selection-group h4 {
    margin-bottom: var(--space-md);
    font-size: 1rem;
    color: var(--color-text);
}

.selection-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
}

.team-select-btn {
    border: 2px solid transparent;
    transition: border-color 0.2s, background-color 0.2s;
    min-height: var(--touch-comfortable);
}

.team-select-btn.selected {
    border-color: var(--color-text);
}

.team-red {
    background-color: var(--color-red);
    color: var(--color-text);
}

.team-blue {
    background-color: var(--color-blue);
    color: var(--color-text);
}

.role-select-btn {
    background-color: var(--color-bg-light);
    color: var(--color-text);
    border: 2px solid transparent;
}

.role-select-btn.selected {
    border-color: var(--color-accent);
}

/* ============================================ */
/* ğŸƒ Game Screen */
/* ============================================ */
#game-screen {
    /* NEW: Adjust grid for fixed controls footer */
    display: grid;
    grid-template-rows: auto 1fr; /* Header then board container */
    gap: 0;
    padding: 0 !important; /* Remove screen padding */
}

.game-header {
    background-color: var(--color-bg);
    padding: var(--space-md);
    padding-top: calc(var(--safe-top) + var(--space-md));
    position: sticky;
    top: 0;
    z-index: 50;
    box-shadow: var(--shadow-sm);
}

/* NEW: Player Badge Style */
.player-badge {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--color-bg-light);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-md);
    font-weight: 700;
    font-size: 1.05rem;
    box-shadow: var(--shadow-sm);
    white-space: nowrap;
}

#badge-info {
    color: var(--color-text);
}

#badge-score {
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.9rem;
    min-width: 30px;
    text-align: center;
}

/* Player Badge Theme Colors */
.badge-red #badge-score {
    background: var(--color-red);
    color: var(--color-text);
}

.badge-blue #badge-score {
    background: var(--color-blue);
    color: var(--color-text);
}

.game-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    font-weight: 700;
}

.score-display {
    display: flex;
    align-items: center;
    font-size: 1.5rem;
}

.score-red {
    color: var(--color-red);
}

.score-blue {
    color: var(--color-blue);
}

.turn-indicator {
    text-align: center;
    font-size: 1rem;
    color: var(--color-text-muted);
}

#current-turn {
    font-weight: 800;
    font-size: 1.1rem;
}

.clue-display {
    background-color: var(--color-bg-light);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    text-align: center;
    font-size: 1rem;
}

.clue-display p {
    color: var(--color-text-muted);
    margin: 0;
}

.clue-word {
    font-weight: 700;
    color: var(--color-accent);
}

/* Game Board */
.game-board-container {
    overflow-y: auto;
    /* NEW: Padding to compensate for the fixed controls */
    padding: var(--space-md);
    padding-bottom: 200px; 
}

#game-board {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-sm);
}

.card {
    background-color: var(--color-card-bg);
    color: var(--color-card-text);
    border-radius: var(--radius-md);
    padding: var(--space-md) var(--space-sm);
    text-align: center;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
    user-select: none;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.1s, box-shadow 0.1s;
    box-shadow: var(--shadow-sm);
}

.card:hover:not(.revealed):not(.spymaster-view) {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}

/* Spymaster View */
.spymaster-view[data-type="RED"] {
    border: 3px solid var(--color-red);
}

.spymaster-view[data-type="BLUE"] {
    border: 3px solid var(--color-blue);
}

.spymaster-view[data-type="NEUTRAL"] {
    border: 3px solid var(--color-neutral);
}

.spymaster-view[data-type="ASSASSIN"] {
    border: 3px solid var(--color-assassin);
}

/* Revealed Cards */
.revealed {
    cursor: default;
    transform: none !important;
    box-shadow: none !important;
    color: var(--color-bg);
    font-weight: 700;
}

.revealed[data-type="RED"] {
    background-color: var(--color-red);
}

.revealed[data-type="BLUE"] {
    background-color: var(--color-blue);
}

.revealed[data-type="NEUTRAL"] {
    background-color: var(--color-neutral);
}

.revealed[data-type="ASSASSIN"] {
    background-color: var(--color-assassin);
    color: var(--color-text);
}

/* Game Controls (NEW: Fixed Footer) */
.game-controls {
    /* FIX: Make controls a fixed footer on mobile */
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background: var(--color-bg);
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.4);
    padding: var(--space-md);
    padding-top: var(--space-sm);
    padding-bottom: calc(var(--safe-bottom) + var(--space-md));
    z-index: 100;
}

/* Spymaster Input Group */
.control-input-group {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

#count-input {
    flex-grow: 0;
    width: 80px; /* Smaller width for count input */
    text-align: center;
}

/* ============================================ */
/* âš ï¸ Modal & Toasts */
/* ============================================ */
#modal-overlay {
    /* ... (CSS for Modal Overlay) ... */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s;
}

#modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

#modal-content {
    background: var(--color-bg-light);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    max-width: 90%;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s;
}

#modal-overlay.active #modal-content {
    transform: scale(1);
}

#modal-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
    display: block;
}

#modal-title {
    font-size: 1.5rem;
    margin-bottom: var(--space-sm);
    font-weight: 700;
}

#modal-message {
    color: var(--color-text-muted);
    margin-bottom: var(--space-lg);
}

#modal-buttons {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
}

#modal-buttons button {
    flex: 1;
}

/* Toast Messages */
#toast-container {
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + var(--space-md));
    left: 50%;
    transform: translateX(-50%);
    z-index: 300;
    width: 90%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.toast {
    background-color: var(--color-bg-light);
    color: var(--color-text);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s, transform 0.3s;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}
    </style>
</head>
<body>
    <div id="app-container">

        <div id="onboarding-screen" class="screen">
            <div id="onboarding-container">
                <div class="onboarding-slide">
                    <span class="icon">ğŸ‘‹</span>
                    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
                    <p>Ø§Ù„Ø¹Ø¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦ÙƒØŒ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù„Ø¹Ø¨Ø© Code Names Ø§Ù„Ø´Ù‡ÙŠØ±Ø© Ø¨Ù†Ø³Ø®Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©. Ø§Ù„Ø¹Ø¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†!</p>
                </div>
                <div class="onboarding-slide">
                    <span class="icon">ğŸ¯</span>
                    <h2>ÙØ±ÙŠÙ‚Ø§Ù†ØŒ Ù‡Ø¯Ù ÙˆØ§Ø­Ø¯</h2>
                    <p>ÙØ±ÙŠÙ‚ Ø£Ø­Ù…Ø± ÙˆÙØ±ÙŠÙ‚ Ø£Ø²Ø±Ù‚. ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚ (Spymaster) Ø¥Ø¹Ø·Ø§Ø¡ ØªÙ„Ù…ÙŠØ­ Ù…Ù† ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„Ù…Ø§Øª ÙØ±ÙŠÙ‚Ù‡ Ù„ÙŠØ®Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø®Ù…Ù†ÙˆÙ†.</p>
                </div>
                <div class="onboarding-slide">
                    <span class="icon">ğŸ’€</span>
                    <h2>Ø§Ø­Ø°Ø± Ø§Ù„Ù‚Ø§ØªÙ„!</h2>
                    <p>Ø¥Ø°Ø§ Ø®Ù…Ù† ÙØ±ÙŠÙ‚Ùƒ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ØŒ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙˆØ±Ø§Ù‹ ÙˆØªØ®Ø³Ø±ÙˆÙ†! Ø®Ù…Ù†ÙˆØ§ Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§ØªÙƒÙ… Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙÙˆØ²ÙˆØ§.</p>
                </div>
            </div>
            
            <div id="onboarding-dots" class="onboarding-dots">
                <span class="onboarding-dot active"></span>
                <span class="onboarding-dot"></span>
                <span class="onboarding-dot"></span>
            </div>

            <div class="onboarding-footer">
                <button class="btn-skip" id="btn-skip">ØªØ®Ø·ÙŠ</button>
                <button class="btn btn-primary" id="btn-next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

        <div id="lobby-screen" class="screen hidden">
            <div class="screen-header">
                <h1>Code Names</h1>
                <p>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p>
            </div>

            <div class="input-group">
                <label for="username-input" class="input-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                <input type="text" id="username-input" class="input-text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
            </div>

            <div class="input-group">
                <button class="btn btn-primary btn-full btn-large" id="btn-create-room">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>

            <div class="input-group">
                <label for="room-code-input" class="input-label">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label>
                <input type="text" id="room-code-input" class="input-text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©">
            </div>

            <div class="input-group">
                <button class="btn btn-success btn-full btn-large" id="btn-join-room">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©</button>
            </div>
        </div>

        <div id="waiting-room" class="screen hidden">
            <div class="screen-header">
                <div id="room-code-display">
                    <h2>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</h2>
                    <p id="room-code-text">ABCD</p>
                </div>
            </div>

            <div id="players-section">
                <h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="players-count">1</span>)</h3>
                <ul id="players-list">
                    </ul>
            </div>

            <div class="selection-group">
                <h4>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ:</h4>
                <div class="selection-grid">
                    <button class="btn team-select-btn team-red" data-team="RED" id="btn-team-red">
                        <span class="btn-icon">ğŸ”´</span> <span>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</span>
                    </button>
                    <button class="btn team-select-btn team-blue" data-team="BLUE" id="btn-team-blue">
                        <span class="btn-icon">ğŸ”µ</span> <span>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</span>
                    </button>
                </div>
            </div>

            <div class="selection-group">
                <h4>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ:</h4>
                <div class="selection-grid">
                    <button class="btn role-select-btn" data-role="SPYMASTER" id="btn-role-spymaster">
                        <span class="btn-icon">ğŸ‘‘</span> <span>Ù‚Ø§Ø¦Ø¯ (Spymaster)</span>
                    </button>
                    <button class="btn role-select-btn" data-role="GUESSER" id="btn-role-guesser">
                        <span class="btn-icon">ğŸ¯</span> <span>Ù…Ø®Ù…Ù‘Ù† (Guesser)</span>
                    </button>
                </div>
            </div>
            
            <button class="btn btn-success btn-full btn-large" id="btn-ready-toggle">
                <span class="btn-icon">âœ…</span> <span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨</span>
            </button>

            <button class="btn btn-danger btn-full mt-auto" id="btn-leave-room">
                <span>Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</span>
            </button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                
                <div class="player-badge" id="player-badge">
                    <span id="badge-info"></span>
                    <span id="badge-score"></span>
                </div>
                
                <div class="game-info">
                    <div class="score-display score-red">
                        <span class="btn-icon">ğŸ”´</span> <span id="red-score">8</span>
                    </div>
                    <div class="turn-indicator">
                        <p>Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ:</p>
                        <p id="current-turn">...</p>
                    </div>
                    <div class="score-display score-blue">
                        <span id="blue-score">7</span> <span class="btn-icon">ğŸ”µ</span>
                    </div>
                </div>

                <div class="clue-display hidden" id="clue-display-wrapper">
                    <p>Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø­Ø§Ù„ÙŠ:</p>
                    <p>
                        <span class="clue-word" id="clue-word">Ø´Ø¬Ø±Ø©</span> (<span id="clue-count">3</span>)
                    </p>
                </div>
            </div>
            
            <div class="game-board-container">
                <div id="game-board">
                    </div>
            </div>

            <div class="game-controls">
                <div id="spymaster-controls" class="hidden">
                    <div class="control-input-group">
                        <input type="text" id="clue-input" class="control-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­">
                        <input type="number" id="count-input" class="control-input" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" min="1" max="9">
                    </div>
                    <button class="btn btn-accent btn-full" id="btn-give-clue">
                        <span class="btn-icon">ğŸ’¡</span> <span>Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØªÙ„Ù…ÙŠØ­</span>
                    </button>
                </div>
                <div id="guesser-controls" class="hidden">
                    <button class="btn btn-danger btn-full" id="btn-end-turn">
                        <span class="btn-icon">â­</span> <span>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <span id="modal-icon"></span>
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div id="modal-buttons">
                </div>
        </div>
    </div>

    <div id="toast-container">
        </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ============================================
        // âš™ï¸ GLOBAL STATE
        // ============================================
        let userState = {
            userId: localStorage.getItem('userId') || crypto.randomUUID(),
            username: localStorage.getItem('username') || '',
        };
        let gameState = {};
        let socket;
        let currentSlide = 0; // NEW: Onboarding slide tracker

        // Save generated UserId
        if (!localStorage.getItem('userId')) {
            localStorage.setItem('userId', userState.userId);
        }

        // ============================================
        // ğŸ’¬ MODAL AND TOAST UTILITIES
        // ============================================
        const Modal = {
            // ... (Existing Modal implementation) ...
            show: (options) => {
                // Simplified stub for display purposes
                document.getElementById('modal-icon').textContent = options.icon || '';
                document.getElementById('modal-title').textContent = options.title || 'Ø±Ø³Ø§Ù„Ø©';
                document.getElementById('modal-message').textContent = options.message || '';
                
                const buttonsContainer = document.getElementById('modal-buttons');
                buttonsContainer.innerHTML = '';
                
                const btnOK = document.createElement('button');
                btnOK.className = 'btn btn-primary';
                btnOK.textContent = 'Ø­Ø³Ù†Ø§Ù‹';
                btnOK.onclick = Modal.hide;
                buttonsContainer.appendChild(btnOK);
                
                if (options.onConfirm) {
                    btnOK.textContent = 'ØªØ£ÙƒÙŠØ¯';
                    const btnCancel = document.createElement('button');
                    btnCancel.className = 'btn btn-danger';
                    btnCancel.textContent = 'Ø¥Ù„ØºØ§Ø¡';
                    btnCancel.onclick = Modal.hide;
                    
                    btnOK.onclick = () => {
                        options.onConfirm();
                        Modal.hide();
                    };
                    buttonsContainer.prepend(btnCancel);
                }
                
                document.getElementById('modal-overlay').classList.add('active');
            },
            hide: () => {
                document.getElementById('modal-overlay').classList.remove('active');
            },
            confirm: (message, onConfirm) => {
                Modal.show({
                    icon: 'â“',
                    title: 'ØªØ£ÙƒÙŠØ¯',
                    message: message,
                    onConfirm: onConfirm
                });
            },
            error: (message, title = 'Ø®Ø·Ø£') => {
                Modal.show({
                    icon: 'ğŸš¨',
                    title: title,
                    message: message,
                });
            },
            success: (message, title = 'Ù†Ø¬Ø§Ø­') => {
                Modal.show({
                    icon: 'ğŸ‰',
                    title: title,
                    message: message,
                });
            }
        };

        const Toast = {
            // ... (Existing Toast implementation) ...
            show: (message, type = 'info', duration = 3000) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            }
        };

        const vibrate = (pattern) => {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(pattern);
            }
        };

        // ============================================
        // ğŸ”„ SCREEN MANAGEMENT
        // ============================================
        const switchScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };

        // ============================================
        // ğŸš€ ONBOARDING LOGIC (NEW: Fixed Logic)
        // ============================================
        const finishOnboarding = () => {
            localStorage.setItem('onboarding_completed', 'true');
            if (userState.username) {
                switchScreen('lobby-screen');
            } else {
                switchScreen('lobby-screen'); // Stay on lobby if no username
            }
        };

        const setupOnboarding = () => {
            const container = document.getElementById('onboarding-container');
            const dots = document.getElementById('onboarding-dots');
            const btnNext = document.getElementById('btn-next');
            const btnSkip = document.getElementById('btn-skip');
            let touchStartX = 0;

            const updateDots = () => {
                dots.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === currentSlide);
                });
            };

            const nextSlide = () => {
                if (currentSlide < 2) { // 3 slides: 0, 1, 2
                    currentSlide++;
                    container.scrollTo({ left: container.clientWidth * currentSlide, behavior: 'smooth' });
                    updateDots();
                    vibrate(10);
                } else {
                    finishOnboarding();
                }
            };

            const prevSlide = () => {
                if (currentSlide > 0) {
                    currentSlide--;
                    container.scrollTo({ left: container.clientWidth * currentSlide, behavior: 'smooth' });
                    updateDots();
                    vibrate(10);
                }
            };
            
            // Event Listeners
            btnNext.addEventListener('click', nextSlide);
            btnSkip.addEventListener('click', finishOnboarding);
            
            // Swipe handlers
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });

            container.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > 50) { // Swipe threshold
                    if (diff > 0) {
                        nextSlide(); // Swipe left (next)
                    } else {
                        prevSlide(); // Swipe right (prev)
                    }
                }
            });

            // Initial state
            updateDots();
        };

        // ============================================
        // ğŸšª LOBBY LOGIC
        // ============================================
        const setupLobby = () => {
            const usernameInput = document.getElementById('username-input');
            const roomCodeInput = document.getElementById('room-code-input');
            
            usernameInput.value = userState.username;

            const updateUsername = () => {
                userState.username = usernameInput.value.trim();
                localStorage.setItem('username', userState.username);
            };

            usernameInput.addEventListener('input', updateUsername);

            document.getElementById('btn-create-room').addEventListener('click', () => {
                updateUsername();
                if (userState.username) {
                    socket.emit('createRoom', { username: userState.username, userId: userState.userId });
                    vibrate(10);
                } else {
                    Toast.show('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                }
            });

            document.getElementById('btn-join-room').addEventListener('click', () => {
                updateUsername();
                const roomCode = roomCodeInput.value.trim().toUpperCase();
                if (userState.username && roomCode.length === 4) {
                    socket.emit('joinRoom', { 
                        username: userState.username, 
                        userId: userState.userId, 
                        roomCode: roomCode 
                    });
                    vibrate(10);
                } else {
                    Toast.show('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ±Ù…Ø² ØºØ±ÙØ© ØµØ­ÙŠØ­ÙŠÙ† (4 Ø£Ø­Ø±Ù).', 'error');
                }
            });
        };

        // ============================================
        // ğŸ‘¥ WAITING ROOM LOGIC (MODIFIED)
        // ============================================
        const setupWaitingRoom = () => {
            // Team and Role Selection
            document.querySelectorAll('.team-select-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const team = e.currentTarget.getAttribute('data-team');
                    socket.emit('setTeam', { team });
                    vibrate(10);
                });
            });

            document.querySelectorAll('.role-select-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const role = e.currentTarget.getAttribute('data-role');
                    socket.emit('setRole', { role });
                    vibrate(10);
                });
            });

            // NEW: Ready Toggle Button Logic
            document.getElementById('btn-ready-toggle').addEventListener('click', () => {
                vibrate(10);
                const player = gameState.players.find(p => p.userId === userState.userId);
                if (!player) return;
                
                if (!player.team || !player.role) {
                     Toast.show('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ø¯ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©.', 'error');
                     return;
                }
                
                socket.emit('setReady', { isReady: !player.isReady });
            });

            // Leave Room Button
            document.getElementById('btn-leave-room').addEventListener('click', () => {
                Modal.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ', () => {
                    socket.emit('leaveRoom');
                    gameState = {};
                    switchScreen('lobby-screen');
                    Toast.show('ØªÙ…Øª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©.', 'info');
                });
                vibrate(10);
            });
        };

        const updatePlayersList = (players) => {
            const list = document.getElementById('players-list');
            const count = document.getElementById('players-count');
            const codeText = document.getElementById('room-code-text');
            const readyBtn = document.getElementById('btn-ready-toggle');
            const myPlayer = players.find(p => p.userId === userState.userId);

            codeText.textContent = gameState.code || 'ABCD';
            count.textContent = players.length;
            
            // Render list
            list.innerHTML = players.map(p => {
                const teamIcon = p.team === 'RED' ? 'ğŸ”´' : p.team === 'BLUE' ? 'ğŸ”µ' : 'âšª';
                const roleIcon = p.role === 'SPYMASTER' ? ' ğŸ‘‘' : p.role === 'GUESSER' ? ' ğŸ¯' : '';
                const readyStatus = p.isReady ? ' âœ…' : ' âŒ'; // NEW: Ready Status
                const onlineStatus = p.isOnline === false ? ' â³' : ''; // NEW: Online Status
                return `<li class="${p.isOnline === false ? 'offline-player' : ''}">${teamIcon} ${p.username}${roleIcon}${readyStatus}${onlineStatus}</li>`;
            }).join('');

            // Update Team/Role Buttons (Visual feedback)
            document.querySelectorAll('.team-select-btn, .role-select-btn').forEach(btn => {
                btn.classList.remove('selected');
                const type = btn.getAttribute('data-team') ? 'team' : 'role';
                if (myPlayer && myPlayer[type] === btn.getAttribute(`data-${type}`)) {
                    btn.classList.add('selected');
                }
            });
            
            // Update Ready Button UI
            if (myPlayer) {
                if (myPlayer.isReady) {
                    readyBtn.classList.remove('btn-success');
                    readyBtn.classList.add('btn-danger');
                    readyBtn.innerHTML = '<span class="btn-icon">ğŸš«</span> <span>ØºÙŠØ± Ø¬Ø§Ù‡Ø²</span>';
                } else {
                    readyBtn.classList.add('btn-success');
                    readyBtn.classList.remove('btn-danger');
                    readyBtn.innerHTML = '<span class="btn-icon">âœ…</span> <span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø¨</span>';
                }
                
                // Disable if team/role is not selected
                if (!myPlayer.team || !myPlayer.role) {
                    readyBtn.disabled = true;
                    readyBtn.innerHTML = '<span>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ ÙˆØ¯ÙˆØ±Ùƒ Ø£ÙˆÙ„Ø§Ù‹</span>';
                } else {
                    readyBtn.disabled = false;
                }
            }
        };

        // ============================================
        // ğŸƒ GAME LOGIC (MODIFIED)
        // ============================================
        const setupGame = () => {
            document.getElementById('btn-give-clue').addEventListener('click', () => {
                const word = document.getElementById('clue-input').value.trim();
                const count = parseInt(document.getElementById('count-input').value.trim());

                if (word && count > 0 && count <= 9) {
                    socket.emit('giveClue', { word, count });
                    vibrate(10);
                } else {
                    Toast.show('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙ„Ù…ÙŠØ­ ÙˆØ¹Ø¯Ø¯ ØµØ­ÙŠØ­ (1-9).', 'error');
                }
            });

            document.getElementById('btn-end-turn').addEventListener('click', () => {
                Modal.confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø¯ÙˆØ±Ùƒ Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ®Ù…ÙŠÙ†Ø§ØªØŸ', () => {
                    socket.emit('endTurn');
                    vibrate(10);
                });
            });
            
            document.getElementById('game-board').addEventListener('click', (e) => {
                const cardElement = e.target.closest('.card');
                if (cardElement && !cardElement.classList.contains('revealed')) {
                    const cardIndex = parseInt(cardElement.getAttribute('data-index'));
                    socket.emit('selectCard', { cardIndex });
                    vibrate(10);
                }
            });
        };

        const renderGameBoard = (board, isSpymasterView = false) => {
            const boardContainer = document.getElementById('game-board');
            boardContainer.innerHTML = '';

            board.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.setAttribute('data-index', index);
                cardElement.textContent = card.word;
                
                if (isSpymasterView || card.revealed) {
                    cardElement.setAttribute('data-type', card.type);
                }
                
                if (card.revealed) {
                    cardElement.classList.add('revealed');
                }
                
                if (isSpymasterView) {
                    cardElement.classList.add('spymaster-view');
                }

                boardContainer.appendChild(cardElement);
            });
        };

        const updateControls = () => {
            const player = gameState.players.find(p => p.userId === userState.userId);
            const spymaster = document.getElementById('spymaster-controls');
            const guesser = document.getElementById('guesser-controls');
            
            // Clear inputs for spymaster
            document.getElementById('clue-input').value = '';
            document.getElementById('count-input').value = '';
            
            // Hide all controls initially
            spymaster.classList.add('hidden');
            guesser.classList.add('hidden');
            
            if (gameState.winner) return; // No controls if game is over

            // Check if it's my turn
            const isMyTurn = player && gameState.currentTurn === player.team;
            
            if (isMyTurn) {
                if (player?.role === 'SPYMASTER' && gameState.turnPhase === 'CLUE_GIVING') {
                    spymaster.classList.remove('hidden');
                } else if (player?.role === 'GUESSER' && gameState.turnPhase === 'GUESSING') {
                    guesser.classList.remove('hidden');
                }
            } else if (player?.role === 'SPYMASTER') {
                 // Spymaster controls should be visible to end the turn if the guesser did not use all guesses
            }
        };

        // NEW: Update Player Badge Function
        const updatePlayerBadge = () => {
            const player = gameState.players.find(p => p.userId === userState.userId);
            const badge = document.getElementById('player-badge');
            const infoSpan = document.getElementById('badge-info');
            const scoreSpan = document.getElementById('badge-score');
            
            if (!player || gameState.gameState !== 'IN_PROGRESS') {
                badge.classList.add('hidden');
                return;
            }
            
            badge.classList.remove('hidden');

            const isRed = player.team === 'RED';
            const teamColor = isRed ? 'ğŸ”´' : 'ğŸ”µ';
            const teamName = isRed ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚';
            const roleName = player.role === 'SPYMASTER' ? 'Ù‚Ø§Ø¦Ø¯' : 'Ù…Ø®Ù…Ù‘Ù†';
            const score = isRed ? gameState.redRemaining : gameState.blueRemaining; // Assuming these are tracked

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            infoSpan.textContent = `${teamColor} ${roleName} Ø§Ù„ÙØ±ÙŠÙ‚ ${teamName}`;
            scoreSpan.textContent = `${score}`;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            badge.classList.remove('badge-red', 'badge-blue');
            badge.classList.add(isRed ? 'badge-red' : 'badge-blue');
            
            // Show current clue if available
            const clueText = document.getElementById('clue-display-wrapper');
            if (gameState.clue && gameState.clue.word) {
                const clueWord = document.getElementById('clue-word');
                const clueCount = document.getElementById('clue-count');
                clueWord.textContent = gameState.clue.word;
                clueCount.textContent = gameState.guessesLeft;
                clueText.classList.remove('hidden');
            } else {
                 clueText.classList.add('hidden');
            }
        };

        const updateGameUI = () => {
            const player = gameState.players.find(p => p.userId === userState.userId);
            const isSpymaster = player && player.role === 'SPYMASTER';
            
            if (gameState.currentTurn) {
                const turnText = gameState.currentTurn === 'RED' ? 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
                document.getElementById('current-turn').textContent = turnText;
            }
            
            updateScores();
            updateControls(); // NEW: Check controls visibility
            updatePlayerBadge(); // NEW: Update the fixed badge
            
            renderGameBoard(gameState.board, isSpymaster); // Re-render board with view updates

            if (gameState.winner) {
                vibrate([50, 100, 50, 100, 50]);
                const winnerText = gameState.winner === 'RED' ? 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
                Modal.show({
                    icon: 'ğŸ†',
                    title: 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!',
                    message: `ÙØ§Ø² ${winnerText}! ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ğŸ‰`
                });
            }
        };

        const updateScores = () => {
            if (!gameState.board) return;
            
            let redRemaining = 0, blueRemaining = 0;
            gameState.board.forEach(card => {
                if (!card.revealed) {
                    if (card.type === 'RED') redRemaining++;
                    if (card.type === 'BLUE') blueRemaining++;
                }
            });
            
            // Assume gameState properties are updated by server
            gameState.redRemaining = redRemaining;
            gameState.blueRemaining = blueRemaining;

            document.getElementById('red-score').textContent = redRemaining;
            document.getElementById('blue-score').textContent = blueRemaining;
        };

        // ============================================
        // âš¡ SOCKET.IO LISTENERS (MODIFIED)
        // ============================================
        const setupSocketListeners = () => {
            socket.on('connect', () => {
                Toast.show('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….', 'success');
            });

            socket.on('disconnect', () => {
                Toast.show('ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.', 'error', 5000);
            });

            socket.on('roomCreated', (data) => {
                gameState = data;
                switchScreen('waiting-room');
                updatePlayersList(gameState.players);
                Toast.show(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ${data.code}`, 'success');
            });

            socket.on('roomUpdate', (players) => {
                gameState.players = players;
                updatePlayersList(players);
            });

            socket.on('gameStarted', (data) => {
                gameState = { ...gameState, ...data }; // Merge game state
                switchScreen('game-screen');
                updateGameUI();
                vibrate([50, 100, 50]);
                Toast.show('Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹!', 'success');
            });

            socket.on('gameUpdate', (data) => {
                gameState = { ...gameState, ...data };
                updateGameUI();
            });
            
            // NEW: Rejoin Game Listener (for persistence)
            socket.on('rejoinGame', (data) => {
                vibrate([10, 50, 10]);
                gameState = data;
                switchScreen(data.gameState === 'IN_PROGRESS' ? 'game-screen' : 'waiting-room');
                if (data.gameState === 'IN_PROGRESS') {
                    updateGameUI(); 
                    Toast.show('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    updatePlayersList(data.players);
                    Toast.show('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }
            });

            socket.on('gameError', (message) => {
                Modal.error(message);
                vibrate([500]);
            });

            socket.on('gameAlert', (message) => {
                Toast.show(message, 'info');
            });
            
            // Optional: Listen for 'leaveRoom' success if needed
            socket.on('roomLeft', () => {
                 gameState = {};
                 switchScreen('lobby-screen');
            });
        };

        // ============================================
        // ğŸ INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // Initialize Socket.io (assuming it connects to the same origin/port)
            socket = io({ 
                 auth: { userId: userState.userId } // Pass userId for re-connection
            }); 
            
            setupSocketListeners();
            setupLobby();
            setupWaitingRoom();
            setupGame();

            // Check onboarding status
            if (localStorage.getItem('onboarding_completed') === 'true') {
                if (userState.username) {
                    switchScreen('lobby-screen');
                } else {
                    switchScreen('lobby-screen');
                }
            } else {
                switchScreen('onboarding-screen');
                setupOnboarding();
            }
        });
    </script>
</body>
</html>
